<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent AI - × ×™×”×•×œ ×–××Ÿ ×—×›×</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --exam: #ef4444;
            --study: #f59e0b;
            --homework: #10b981;
            --activity: #0ea5e9;
            --school: #6366f1;
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }

        /* --- AI Insights Header --- */
        .ai-status-bar {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white; padding: 20px; border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.2);
            margin-bottom: 20px;
        }
        .ai-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .ai-message { font-size: 1rem; font-weight: 600; margin-top: 10px; line-height: 1.4; }

        .app-container { width: 92%; max-width: 800px; margin: 0 auto; padding-bottom: 100px; }

        /* --- Dashboard Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); }
        .stat-card span { font-size: 0.8rem; color: var(--muted); display: block; }
        .stat-card strong { font-size: 1.2rem; color: var(--primary); }

        /* --- Views & Calendar --- */
        .view-switcher { display: flex; background: #eee; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .view-btn { flex: 1; border: none; padding: 8px; border-radius: 10px; cursor: pointer; font-weight: 600; color: var(--muted); }
        .view-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .calendar-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; position: relative; font-size: 0.9rem; }
        .day.selected { background: var(--primary); color: white; }
        .day.conflict { background: #fee2e2; color: #ef4444; }
        .dot { width: 4px; height: 4px; border-radius: 50%; position: absolute; bottom: 4px; }

        /* --- Modals & Forms --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center; }
        .modal { background: white; padding: 25px; border-radius: 24px; width: 90%; max-width: 450px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--muted); margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; }
        
        .conflict-warning { background: #fff1f2; color: #e11d48; padding: 10px; border-radius: 10px; font-size: 0.8rem; margin-bottom: 15px; display: none; border: 1px solid #fda4af; }

        /* --- FAB & Nav --- */
        .fab { position: fixed; bottom: 85px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; border: none; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4); z-index: 2000; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); z-index: 2500; }
        .nav-item { border: none; background: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
        .nav-item.active { color: var(--primary); }

        .event-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 15px; margin-bottom: 10px; border-right: 5px solid var(--primary); }
    </style>
</head>
<body>

    <div class="ai-status-bar">
        <span class="ai-badge">Smart AI Insights</span>
        <div class="ai-message" id="ai-insight-text">×× ×ª×— ××ª ×”×œ×•"×– ×©×œ×š...</div>
    </div>

    <div class="app-container">
        <div class="stats-grid">
            <div class="stat-card"><span>×¢×•××¡ ×©×‘×•×¢×™</span><strong id="stat-load">×¨×’×™×œ</strong></div>
            <div class="stat-card"><span>××©×™××•×ª ×¤×ª×•×—×•×ª</span><strong id="stat-tasks">0</strong></div>
            <div class="stat-card"><span>××‘×—×Ÿ ×§×¨×•×‘</span><strong id="stat-exam">--</strong></div>
        </div>

        <div class="view-switcher">
            <button class="view-btn active" id="btn-personal" onclick="switchTab('personal')">×”×™×•××Ÿ ×©×œ×™</button>
            <button class="view-btn" id="btn-school" onclick="switchTab('school')">×œ×•×— ×‘×™×ª ×¡×¤×¨</button>
        </div>

        <div class="card" id="calendar-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="changeMonth(-1)" style="border:none;background:none;">â–¶</button>
                <strong id="monthYearLabel"></strong>
                <button onclick="changeMonth(1)" style="border:none;background:none;">â—€</button>
            </div>
            <div class="cal-grid" id="calendarGrid"></div>
        </div>

        <h3 id="dailyLabel" style="margin-top:25px;">××™×¨×•×¢×™× ×œ×”×™×•×:</h3>
        <div id="dailyAgenda"></div>
    </div>

    <button class="fab" onclick="openModal()">+</button>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('personal')"><i class="material-icons-round">person</i><span>×™×•××Ÿ</span></button>
        <button class="nav-item" onclick="openModal()"><i class="material-icons-round">add</i><span>×”×•×¡×¤×”</span></button>
        <button class="nav-item" onclick="switchTab('school')"><i class="material-icons-round">groups</i><span>×‘×™"×¡</span></button>
    </nav>

    <div class="overlay" id="eventModal">
        <div class="modal">
            <h3 id="modalTitle">××™×¨×•×¢ ×—×“×©</h3>
            <div class="conflict-warning" id="conflict-msg">×©×™× ×œ×‘: ×™×© ×›×‘×¨ ××™×¨×•×¢ ×‘×©×¢×” ×–×•!</div>
            
            <div class="form-group">
                <label>× ×•×©×</label>
                <input type="text" id="ev-title" oninput="checkConflictRealTime()">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>×¡×•×’</label>
                    <select id="ev-type" onchange="toggleAIPlan()">
                        <option value="××˜×œ×”">×©×™×¢×•×¨×™ ×‘×™×ª</option>
                        <option value="××‘×—×Ÿ">××‘×—×Ÿ</option>
                        <option value="×¤×¢×™×œ×•×ª">×¤×¢×™×œ×•×ª/×—×•×’</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>×ª××¨×™×š</label>
                    <input type="date" id="ev-date" onchange="checkConflictRealTime()">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>×©×¢×”</label>
                    <input type="time" id="ev-time" value="16:00" onchange="checkConflictRealTime()">
                </div>
                <div class="form-group" style="flex:1">
                    <label>××©×š (×“×§×•×ª)</label>
                    <input type="number" id="ev-dur" value="60">
                </div>
            </div>

            <div id="ai-plan-box" style="display:none; background:var(--primary-light); padding:12px; border-radius:12px; margin-bottom:15px;">
                <label style="display:flex; align-items:center; gap:8px; color:var(--primary);">
                    <input type="checkbox" id="ev-auto-ai" checked> ×ª×›× ×•×Ÿ ×œ××™×“×” ×—×›× (AI)
                </label>
                <small style="color:var(--muted)">×”××¢×¨×›×ª ×ª××¦× ×¢×‘×•×¨×š ××ª ×”×©×¢×•×ª ×”×¤× ×•×™×•×ª ×”×›×™ ×˜×•×‘×•×ª.</small>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:var(--primary); color:white; flex:2; padding:12px; border-radius:12px; border:none; font-weight:700;" onclick="saveEvent()">×©××•×¨</button>
                <button class="btn" style="background:var(--bg); flex:1; padding:12px; border-radius:12px; border:none;" onclick="closeModal()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- Configuration & Data ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjUOZw7k1RUW9HArAZPEpdX7L1HP5jpMGasjeFC0jwNSylvDLUEyYQUqIq46YhEpTu/exec";
        let personalEvents = JSON.parse(localStorage.getItem('smart_student_v10')) || [];
        let schoolEvents = [];
        let currentTab = 'personal';
        let selectedDate = new Date();
        let viewDate = new Date();

        function normalizeDate(d) { const date = new Date(d); return new Date(date.getFullYear(), date.getMonth(), date.getDate()); }
        selectedDate = normalizeDate(selectedDate);

        // --- AI Engine (×”×œ×‘ ×©×œ ×”××¢×¨×›×ª) ---

        function runAIAnalysis() {
            const insightText = document.getElementById('ai-insight-text');
            const now = new Date();
            const weekLater = new Date(); weekLater.setDate(now.getDate() + 7);
            
            // 1. ×–×™×”×•×™ ×¢×•××¡ ×©×‘×•×¢×™
            const weekEvents = [...personalEvents, ...schoolEvents].filter(e => {
                const d = new Date(e.date);
                return d >= now && d <= weekLater;
            });

            const examsCount = weekEvents.filter(e => e.type === '××‘×—×Ÿ').length;
            
            if (examsCount >= 2) {
                insightText.innerHTML = `âš ï¸ ×©×™× ×œ×‘! ×™×© ×œ×š ${examsCount} ××‘×—× ×™× ×”×©×‘×•×¢. ×”×œ×•"×– ×¦×¤×•×£, ×›×“××™ ×œ×”×ª×—×™×œ ×œ×œ××•×“ ×›×‘×¨ ×”×™×•×.`;
                document.getElementById('stat-load').innerText = "×’×‘×•×” ğŸ”¥";
                document.getElementById('stat-load').style.color = "var(--exam)";
            } else if (weekEvents.length > 5) {
                insightText.innerHTML = `ğŸ“… ×©×‘×•×¢ ×¤×¢×™×œ ×œ×¤× ×™×š. ××¦××ª×™ ×œ×š ×›××” ×—×œ×•× ×•×ª ×–××Ÿ ×¤× ×•×™×™× ×‘×¢×¨×‘ ×œ×©×™×¢×•×¨×™ ×”×‘×™×ª.`;
                document.getElementById('stat-load').innerText = "×‘×™× ×•× ×™";
            } else {
                insightText.innerHTML = `ğŸŒŸ ×”×œ×•"×– ×©×œ×š ×××•×–×Ÿ. ×–×” ×–××Ÿ ××¦×•×™×Ÿ ×œ×”×ª×§×“× ×‘××˜×œ×•×ª ××¨×•×›×•×ª ×˜×•×•×—.`;
                document.getElementById('stat-load').innerText = "×¨×’×™×œ";
            }

            // 2. ×”××œ×¦×ª ×œ××™×“×” ×¡×¤×¦×™×¤×™×ª
            const nextExam = weekEvents.find(e => e.type === '××‘×—×Ÿ');
            if (nextExam) {
                insightText.innerHTML += `<br>ğŸ’¡ ×”××œ×¦×”: ××¦××ª×™ ×©×‘×™×•× ${new Date(nextExam.date).toLocaleDateString('he-IL', {weekday:'long'})} ×™×© ×œ×š ×¤×—×•×ª ××™×¨×•×¢×™×, ×–×” ×–××Ÿ ××¢×•×œ×” ×œ×—×¨×™×©×”.`;
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×©×™×‘×•×¥ ×—×›× - ××—×¤×©×ª ×—×œ×•× ×•×ª ×¤× ×•×™×™×
        function smartScheduleStudy(examTitle, examDateStr) {
            const examDate = new Date(examDateStr);
            let blocksAdded = 0;

            for (let i = 1; i <= 4 && blocksAdded < 3; i++) {
                let targetDate = new Date(examDate);
                targetDate.setDate(examDate.getDate() - i);
                if (targetDate <= new Date()) continue;

                // ×‘×“×™×§×ª ×—×œ×•× ×•×ª ×–××Ÿ ×¤× ×•×™×™× (16:00, 18:00, 20:00)
                const options = ["16:00", "18:00", "20:00"];
                let foundSlot = false;

                for (let slot of options) {
                    if (!checkConflict(targetDate.toISOString().split('T')[0], slot)) {
                        personalEvents.push({
                            id: "ai-" + Date.now() + i,
                            title: "×œ××™×“×”: " + examTitle,
                            type: "×œ××™×“×”",
                            date: targetDate.toISOString().split('T')[0],
                            time: slot,
                            dur: 90
                        });
                        blocksAdded++;
                        foundSlot = true;
                        break;
                    }
                }
            }
        }

        function checkConflict(date, time) {
            return [...personalEvents, ...schoolEvents].some(e => 
                e.date === date && e.time === time
            );
        }

        function checkConflictRealTime() {
            const date = document.getElementById('ev-date').value;
            const time = document.getElementById('ev-time').value;
            const msg = document.getElementById('conflict-msg');
            msg.style.display = checkConflict(date, time) ? 'block' : 'none';
        }

        // --- UI & Logic ---

        async function loadData() {
            if (!SCRIPT_URL.includes("×›××Ÿ_×”×œ×™× ×§")) {
                try {
                    const res = await fetch(SCRIPT_URL);
                    schoolEvents = await res.json();
                } catch(e) {}
            }
            refreshUI();
        }

        function refreshUI() {
            renderCalendar();
            renderDaily();
            runAIAnalysis();
            document.getElementById('stat-tasks').innerText = personalEvents.length;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('monthYearLabel').innerText = viewDate.toLocaleDateString('he-IL', {month:'long', year:'numeric'});
            
            const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const days = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();

            ['×','×‘','×’','×“','×”','×•','×©'].forEach(d => grid.innerHTML += `<div style="font-size:0.7rem;font-weight:800;color:var(--muted)">${d}</div>`);
            for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
            
            for (let d = 1; d <= days; d++) {
                const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
                const dateStr = date.toISOString().split('T')[0];
                const isSelected = dateStr === selectedDate.toISOString().split('T')[0];
                const hasEvent = [...personalEvents, ...schoolEvents].some(e => e.date === dateStr);
                
                grid.innerHTML += `<div class="day ${isSelected ? 'selected' : ''}" onclick="selectDate(${d})">${d}${hasEvent ? '<div class="dot" style="background:white"></div>' : ''}</div>`;
            }
        }

        function renderDaily() {
            const list = document.getElementById('dailyAgenda');
            list.innerHTML = '';
            const dateStr = selectedDate.toISOString().split('T')[0];
            const daily = [...personalEvents, ...schoolEvents].filter(e => e.date === dateStr);
            
            if(daily.length === 0) { list.innerHTML = "<p style='text-align:center; color:var(--muted)'>××™×Ÿ ×ª×•×›× ×™×•×ª ×œ×”×™×•×. ×–××Ÿ ×œ× ×•×—!</p>"; return; }
            
            daily.sort((a,b) => a.time.localeCompare(b.time)).forEach(e => {
                list.innerHTML += `<div class="event-item" style="border-right-color:var(--${e.type==='××‘×—×Ÿ'?'exam':(e.type==='×œ××™×“×”'?'study':'primary')})">
                    <div><strong>${e.title}</strong><br><span>${e.time} | ${e.type}</span></div>
                    <button onclick="deleteEvent('${e.id}')" style="border:none;background:none;color:var(--exam)"><i class="material-icons-round">delete_outline</i></button>
                </div>`;
            });
        }

        function saveEvent() {
            const title = document.getElementById('ev-title').value;
            const date = document.getElementById('ev-date').value;
            const time = document.getElementById('ev-time').value;
            const type = document.getElementById('ev-type').value;
            const autoAI = document.getElementById('ev-auto-ai').checked;

            if(!title || !date) return alert("××œ× ×¤×¨×˜×™×!");

            if (currentTab === 'personal') {
                personalEvents.push({ id: Date.now().toString(), title, date, time, type, dur: document.getElementById('ev-dur').value });
                if(type === '××‘×—×Ÿ' && autoAI) smartScheduleStudy(title, date);
                localStorage.setItem('smart_student_v10', JSON.stringify(personalEvents));
            } else {
                syncToCloud(title, date, time, type);
            }
            
            closeModal();
            refreshUI();
        }

        async function syncToCloud(title, date, time, type) {
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "add", title, date, time, type }) });
            setTimeout(loadData, 1500);
        }

        function deleteEvent(id) {
            personalEvents = personalEvents.filter(e => e.id !== id);
            localStorage.setItem('smart_student_v10', JSON.stringify(personalEvents));
            refreshUI();
        }

        function openModal() { document.getElementById('eventModal').style.display = 'flex'; document.getElementById('ev-date').value = selectedDate.toISOString().split('T')[0]; }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }
        function toggleAIPlan() { document.getElementById('ai-plan-box').style.display = document.getElementById('ev-type').value === '××‘×—×Ÿ' ? 'block' : 'none'; }
        function selectDate(d) { selectedDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d); refreshUI(); }
        function changeMonth(dir) { viewDate.setMonth(viewDate.getMonth() + dir); renderCalendar(); }
        function switchTab(t) { currentTab = t; document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); refreshUI(); }

        loadData();
    </script>
</body>
</html>