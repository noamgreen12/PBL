<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent AI Planner</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --safe: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --radius: 12px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Layout */
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        
        /* Sidebar (Desktop) / Bottom Nav (Mobile) */
        .nav-sidebar {
            background: var(--card-bg);
            width: 250px;
            display: none; /* Mobile default */
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-light);
            transition: 0.2s;
        }
        .nav-item.active { background: #eaf2fd; color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Space for bottom nav */
            position: relative;
        }

        /* Typography & Components */
        h1, h2, h3 { margin: 0 0 10px 0; }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
        }

        /* AI Insights Box */
        .ai-insight {
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
            border-right: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        .ai-badge {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Load Indicators */
        .load-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 5px; }
        .load-green { background: var(--safe); }
        .load-orange { background: var(--warning); }
        .load-red { background: var(--danger); }

        /* Event List */
        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .event-item:last-child { border-bottom: none; }
        .event-time { font-weight: bold; min-width: 60px; color: var(--primary); }
        .event-details { flex: 1; }
        .event-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #eee; margin-right: 5px; }
        .tag-exam { background: #ffebee; color: #c62828; }
        .tag-study { background: #e3f2fd; color: #1565c0; }
        .tag-school { background: #f3e5f5; color: #6a1b9a; opacity: 0.7; }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4);
            cursor: pointer;
            z-index: 101;
        }

        /* Modal/BottomSheet */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
            align-items: flex-end; /* Bottom sheet on mobile */
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            width: 100%;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        /* Form */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 12px;
            border: 1px solid #ddd; border-radius: 8px;
            font-family: var(--font); font-size: 1rem;
        }
        button {
            width: 100%; padding: 14px;
            border: none; border-radius: 8px;
            font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #eee; color: #333; margin-top: 10px; }

        /* Notifications */
        .notification {
            background: #fff3cd; color: #856404;
            padding: 10px; border-radius: 8px;
            margin-bottom: 10px; font-size: 0.9rem;
            border: 1px solid #ffeeba;
        }

        /* Calendar Grid (Simplified) */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .cal-day { 
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 1px solid #eee; border-radius: 8px; font-size: 0.8rem; position: relative;
        }
        .cal-day.today { border-color: var(--primary); font-weight: bold; }
        .cal-day.has-event::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--primary); border-radius: 50%; }

        @media (min-width: 768px) {
            .nav-sidebar { display: flex; }
            .nav-bottom { display: none; }
            .modal-overlay { align-items: center; justify-content: center; }
            .modal-content { width: 400px; border-radius: var(--radius); animation: fadeIn 0.3s ease; }
            .main-content { padding-bottom: 20px; }
            .fab { left: 40px; bottom: 40px; }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <nav class="nav-sidebar">
        <h2>SmartStudent</h2>
        <div class="nav-item active" onclick="switchTab('dashboard')">
            <span class="nav-icon">ğŸ“Š</span> ×“××©×‘×•×¨×“
        </div>
        <div class="nav-item" onclick="switchTab('calendar')">
            <span class="nav-icon">ğŸ“…</span> ×”×™×•××Ÿ ×©×œ×™
        </div>
        <div class="nav-item" onclick="switchTab('school')">
            <span class="nav-icon">ğŸ«</span> ×œ×•×— ×‘×™×ª ×¡×¤×¨
        </div>
    </nav>

    <main class="main-content" id="mainView">
        </main>

    <nav class="nav-bottom">
        <div class="nav-item active" onclick="switchTab('dashboard')"><span class="nav-icon">ğŸ“Š</span></div>
        <div class="nav-item" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span></div>
        <div class="nav-item" onclick="switchTab('school')"><span class="nav-icon">ğŸ«</span></div>
    </nav>
</div>

<div class="fab" onclick="openModal()">+</div>

<div class="modal-overlay" id="eventModal">
    <div class="modal-content">
        <h3>×”×•×¡×¤×ª ××™×¨×•×¢</h3>
        <div class="notification hidden" id="aiWarning"></div>
        <form id="addEventForm" onsubmit="handleFormSubmit(event)">
            <div class="form-group">
                <label>×›×•×ª×¨×ª</label>
                <input type="text" id="evtTitle" required placeholder="×œ×“×•×’××”: ××‘×—×Ÿ ×‘××ª××˜×™×§×”">
            </div>
            <div class="form-group">
                <label>×¡×•×’</label>
                <select id="evtType" onchange="checkExamMode()">
                    <option value="activity">×¤×¢×™×œ×•×ª / ×—×•×’</option>
                    <option value="assignment">××˜×œ×”</option>
                    <option value="exam">××‘×—×Ÿ</option>
                    <option value="study">×‘×œ×•×§ ×œ××™×“×”</option>
                </select>
            </div>
            <div class="form-group">
                <label>×ª××¨×™×š</label>
                <input type="date" id="evtDate" required onchange="analyzeDateLoad()">
            </div>
            <div class="form-group">
                <label>×©×¢×”</label>
                <input type="time" id="evtTime" required>
            </div>
            <div class="form-group">
                <label>××©×š (×‘×©×¢×•×ª)</label>
                <input type="number" id="evtDuration" value="1" min="0.5" step="0.5" required>
            </div>
            <div id="aiSuggestionBox" class="ai-insight hidden">
                <strong>ğŸ’¡ ×”×¦×¢×ª AI:</strong>
                <p id="aiSuggestionText" style="font-size: 0.9rem; margin: 5px 0;"></p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button type="button" class="btn-primary" style="padding:8px; font-size:0.8rem" onclick="applyAiSuggestion()">×§×‘×œ ×”×¦×¢×”</button>
                </div>
            </div>
            <button type="submit" class="btn-primary">×©××•×¨</button>
            <button type="button" class="btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
        </form>
    </div>
</div>

<script>
    /**
     * Data Model & State
     */
    const STATE = {
        personalEvents: [],
        schoolEvents: [], // Read only overlay
        view: 'dashboard'
    };

    // Initialization
    function init() {
        loadData();
        if (STATE.personalEvents.length === 0) {
            seedData();
        }
        render();
        setupDateInputs();
    }

    function loadData() {
        const stored = localStorage.getItem('smartStudentData');
        if (stored) {
            const parsed = JSON.parse(stored);
            STATE.personalEvents = parsed.personalEvents || [];
            STATE.schoolEvents = parsed.schoolEvents || [];
        }
    }

    function saveData() {
        localStorage.setItem('smartStudentData', JSON.stringify(STATE));
        render();
    }

    function seedData() {
        // Sample Data
        const today = new Date().toISOString().split('T')[0];
        STATE.schoolEvents = [
            { id: 's1', title: '×˜×™×•×œ ×©× ×ª×™ ×©×›×‘×” ×™×³', date: addDays(today, 5), type: 'school', audience: 'shichva' }
        ];
        STATE.personalEvents = [
            { id: 1, title: '×—×•×’ ×›×“×•×¨×¡×œ', type: 'activity', date: today, time: '16:00', duration: 2, isAuto: false },
            { id: 2, title: '×©×™×¢×•×¨×™ ×‘×™×ª ×× ×’×œ×™×ª', type: 'assignment', date: today, time: '19:00', duration: 1, isAuto: false }
        ];
        saveData();
    }

    /**
     * Heuristic AI Engine (The Brain)
     */
    const AI = {
        // Calculate load score for a specific date (0-100)
        calculateDailyLoad: (dateStr) => {
            const events = STATE.personalEvents.filter(e => e.date === dateStr);
            const totalHours = events.reduce((sum, e) => sum + parseFloat(e.duration), 0);
            const examCount = events.filter(e => e.type === 'exam').length;
            
            let score = (totalHours * 10) + (examCount * 30);
            return { score, hours: totalHours, exams: examCount };
        },

        // Find optimal study slots backwards from exam date
        findStudySlots: (examDate, examSubject) => {
            const suggestions = [];
            let neededHours = 4; // Default needed study time
            let daysBack = 1;
            
            // Loop 7 days back
            while (daysBack <= 7 && neededHours > 0) {
                const targetDate = addDays(examDate, -daysBack);
                const load = AI.calculateDailyLoad(targetDate);
                
                // Heuristic: Avoid days with > 5 hours load or existing exams
                if (load.hours < 5 && load.exams === 0) {
                    // Score logic: Prefer 2 days before over day before (cramming)
                    const quality = (daysBack === 1) ? 'medium' : 'high';
                    
                    suggestions.push({
                        date: targetDate,
                        time: '16:00', // Default convenient time
                        duration: 2,
                        reason: `×™×•× ${getDayName(targetDate)} ×¤× ×•×™ ×™×—×¡×™×ª (${load.hours} ×©×¢×•×ª ×ª×¤×•×¡×•×ª ×‘×œ×‘×“)`,
                        quality: quality
                    });
                    neededHours -= 2;
                }
                daysBack++;
            }
            return suggestions;
        },

        // Generate natural language insights for dashboard
        getInsights: () => {
            const today = new Date().toISOString().split('T')[0];
            const load = AI.calculateDailyLoad(today);
            const upcomingExams = STATE.personalEvents
                .filter(e => e.type === 'exam' && e.date >= today)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            let messages = [];

            // 1. Daily Load Insight
            if (load.hours > 6) {
                messages.push({ type: 'danger', text: `×©×™× ×œ×‘: ×”×™×•× ×©×œ×š ×¢××•×¡ ×××•×“ (${load.hours} ×©×¢×•×ª). ×©×§×•×œ ×œ×”×–×™×– ××˜×œ×•×ª ×œ× ×“×—×•×¤×•×ª.` });
            } else if (load.hours < 2) {
                messages.push({ type: 'safe', text: `×”×™×•× ×¨×’×•×¢. ×–×” ×–××Ÿ ××¦×•×™×Ÿ ×œ×”×©×œ×™× ×¤×¢×¨×™× ××• ×œ× ×•×—.` });
            }

            // 2. Exam Prep Insight
            if (upcomingExams.length > 0) {
                const nextExam = upcomingExams[0];
                const daysToExam = (new Date(nextExam.date) - new Date(today)) / (1000 * 60 * 60 * 24);
                
                if (daysToExam < 3 && daysToExam >= 0) {
                     messages.push({ type: 'warning', text: `×”××‘×—×Ÿ ×‘${nextExam.title} ××ª×§×¨×‘ (×¢×•×“ ${Math.ceil(daysToExam)} ×™××™×). ×¤×™× ×™×ª ×–××Ÿ ×œ×—×–×¨×”?` });
                }
                
                // Prioritization logic
                if (upcomingExams.length >= 2) {
                    const secondExam = upcomingExams[1];
                    const gap = (new Date(secondExam.date) - new Date(nextExam.date)) / (1000 * 60 * 60 * 24);
                    if (gap < 3) {
                         messages.push({ type: 'danger', text: `××–×”×¨×ª ×¦×¤×™×¤×•×ª: ×™×© ×œ×š ×©× ×™ ××‘×—× ×™× ×‘×©×‘×•×¢ ××—×“. ×›×“××™ ×œ×”×ª×—×™×œ ×œ×œ××•×“ ×œ${secondExam.title} ×›×‘×¨ ×¢×›×©×™×•.` });
                    }
                }
            }

            return messages;
        }
    };

    /**
     * UI Rendering Logic
     */
    function render() {
        const container = document.getElementById('mainView');
        container.innerHTML = '';
        updateNavState();

        if (STATE.view === 'dashboard') renderDashboard(container);
        else if (STATE.view === 'calendar') renderCalendar(container);
        else if (STATE.view === 'school') renderSchoolBoard(container);
    }

    function renderDashboard(container) {
        const today = new Date().toISOString().split('T')[0];
        const insights = AI.getInsights();
        const load = AI.calculateDailyLoad(today);
        
        // Determine Load Color
        let loadClass = 'load-green', loadText = '×¨×’×•×¢';
        if (load.score > 40) { loadClass = 'load-orange'; loadText = '×‘×™× ×•× ×™'; }
        if (load.score > 70) { loadClass = 'load-red'; loadText = '×¢××•×¡ ×××•×“'; }

        // Insights HTML
        const insightsHtml = insights.map(msg => `
            <div style="margin-bottom:8px; font-size:0.95rem; border-right: 3px solid var(--${msg.type}); padding-right:8px;">
                ${msg.text}
            </div>
        `).join('') || '<p>××™×Ÿ ×”×ª×¨××•×ª ××™×•×—×“×•×ª ×œ×”×™×•×. ×”×›×œ ×‘×©×œ×™×˜×”!</p>';

        // Today's Events
        const todaysEvents = STATE.personalEvents
            .filter(e => e.date === today)
            .sort((a,b) => a.time.localeCompare(b.time));

        let eventsHtml = todaysEvents.length ? '' : '<p style="color:var(--text-light)">××™×Ÿ ××™×¨×•×¢×™× ×œ×”×™×•×</p>';
        todaysEvents.forEach(e => {
            eventsHtml += `
                <div class="event-item">
                    <div class="event-time">${e.time}</div>
                    <div class="event-details">
                        <div><strong>${e.title}</strong></div>
                        <span class="event-tag tag-${e.type}">${getTypeName(e.type)}</span>
                        ${e.isAuto ? '<span class="event-tag">ğŸ¤– AI</span>' : ''}
                    </div>
                </div>
            `;
        });

        container.innerHTML = `
            <h1>×©×œ×•× ×ª×œ××™×“ ğŸ‘‹</h1>
            
            <div class="card ai-insight">
                <span class="ai-badge">× ×™×ª×•×— ×—×›×</span>
                <h3>××” ×”××¦×‘ ×”×™×•×?</h3>
                <div style="margin-bottom:10px;">
                    ×¢×•××¡ ×™×•××™: <strong>${loadText}</strong> <span class="load-indicator ${loadClass}"></span>
                    <br><small>${load.hours} ×©×¢×•×ª ×¤×¢×™×œ×•×ª ××ª×•×›× × ×•×ª</small>
                </div>
                <div style="background:rgba(255,255,255,0.6); padding:10px; border-radius:8px;">
                    ${insightsHtml}
                </div>
            </div>

            <h3>×”×™×•× ×©×œ×™ (${formatDateIL(today)})</h3>
            <div class="card">
                ${eventsHtml}
            </div>
        `;
    }

    function renderCalendar(container) {
        // Simplified List View for robustness + Horizontal Week Scroll
        const days = [];
        const today = new Date();
        for(let i=0; i<7; i++) {
            days.push(addDays(today.toISOString().split('T')[0], i));
        }

        let calendarHtml = `<h2>×”×©×‘×•×¢ ×”×§×¨×•×‘</h2>`;
        
        days.forEach(dateStr => {
            const dayEvents = STATE.personalEvents.filter(e => e.date === dateStr);
            const schoolEvents = STATE.schoolEvents.filter(e => e.date === dateStr);
            const load = AI.calculateDailyLoad(dateStr);
            let color = load.score > 60 ? 'var(--danger)' : (load.score > 30 ? 'var(--warning)' : 'var(--safe)');

            let items = '';
            // Overlay School Events
            schoolEvents.forEach(e => {
                items += `<div class="event-item" style="background:#f9f9f9"><span class="event-time">ğŸ”’</span> ${e.title} <span class="event-tag tag-school">×‘×™×”"×¡</span></div>`;
            });
            // Personal Events
            dayEvents.sort((a,b) => a.time.localeCompare(b.time)).forEach(e => {
                items += `<div class="event-item">
                    <span class="event-time">${e.time}</span>
                    <span>${e.title}</span>
                </div>`;
            });

            calendarHtml += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                        <strong>${getDayName(dateStr)} ${formatDateIL(dateStr)}</strong>
                        <div style="display:flex; align-items:center; font-size:0.8rem;">
                            ×¢×•××¡: <div style="width:10px; height:10px; border-radius:50%; background:${color}; margin-right:5px;"></div>
                        </div>
                    </div>
                    ${items || '<small style="color:#aaa">×¤× ×•×™</small>'}
                </div>
            `;
        });

        container.innerHTML = calendarHtml;
    }

    function renderSchoolBoard(container) {
        let html = `
            <h2>ğŸ« ×œ×•×— ×”×•×“×¢×•×ª ×‘×™×ª ×¡×¤×¨</h2>
            <p style="color:var(--text-light)">×œ×•×— ×–×” ×× ×•×”×œ ×¢×œ ×™×“×™ ×‘×™×ª ×”×¡×¤×¨ ×•××™× ×• × ×™×ª×Ÿ ×œ×¢×¨×™×›×”.</p>
        `;
        
        if (STATE.schoolEvents.length === 0) {
            html += `<div class="card"><p>××™×Ÿ ×”×•×“×¢×•×ª ×—×“×©×•×ª ××‘×™×ª ×”×¡×¤×¨.</p></div>`;
        } else {
            STATE.schoolEvents.forEach(e => {
                html += `
                <div class="card" style="border-right: 4px solid #9c27b0;">
                    <h3>${e.title}</h3>
                    <p>ğŸ“… ${formatDateIL(e.date)}</p>
                    <span class="event-tag tag-school">${e.audience === 'shichva' ? '×©×›×‘×”' : '×›×œ×œ×™'}</span>
                </div>`;
            });
        }
        container.innerHTML = html;
    }

    /**
     * Interaction Logic & AI Form Handling
     */
    function switchTab(viewName) {
        STATE.view = viewName;
        render();
    }

    function updateNavState() {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Simple logic to highlight active based on onclick attribute matching state
        // (Simplified for single-file conciseness)
    }

    function openModal() {
        document.getElementById('eventModal').classList.add('active');
        document.getElementById('aiWarning').classList.add('hidden');
        document.getElementById('aiSuggestionBox').classList.add('hidden');
        document.getElementById('evtDate').value = new Date().toISOString().split('T')[0];
    }

    function closeModal() {
        document.getElementById('eventModal').classList.remove('active');
        document.getElementById('addEventForm').reset();
    }

    function setupDateInputs() {
        // Set min date to today
        document.getElementById('evtDate').min = new Date().toISOString().split('T')[0];
    }

    // AI Check when adding event
    let proposedStudySlots = [];

    function checkExamMode() {
        const type = document.getElementById('evtType').value;
        const suggestionBox = document.getElementById('aiSuggestionBox');
        
        if (type === 'exam') {
            // Wait for date input
        } else {
            suggestionBox.classList.add('hidden');
        }
    }

    function analyzeDateLoad() {
        const date = document.getElementById('evtDate').value;
        const type = document.getElementById('evtType').value;
        const warningBox = document.getElementById('aiWarning');
        const suggestionBox = document.getElementById('aiSuggestionBox');
        
        if (!date) return;

        // 1. Conflict Check
        const load = AI.calculateDailyLoad(date);
        if (load.hours >= 6) {
            warningBox.innerText = `âš ï¸ ×©×™× ×œ×‘! ×‘×™×•× ×–×” ×›×‘×¨ ×™×© ${load.hours} ×©×¢×•×ª ×¤×¢×™×œ×•×ª. ×”×•×¡×¤×ª ××™×¨×•×¢ ×ª×™×¦×•×¨ ×¢×•××¡ ×™×ª×¨.`;
            warningBox.classList.remove('hidden');
        } else {
            warningBox.classList.add('hidden');
        }

        // 2. Exam Study Planner Trigger
        if (type === 'exam') {
            proposedStudySlots = AI.findStudySlots(date);
            if (proposedStudySlots.length > 0) {
                const text = `×™×© ×œ×š ××‘×—×Ÿ ×‘-${formatDateIL(date)}. ×”××¢×¨×›×ª ××™×ª×¨×” ${proposedStudySlots.length} ×—×œ×•× ×•×ª ×–××Ÿ ××•×¤×˜×™××œ×™×™× ×œ×œ××™×“×” ×‘×™××™× ×©×œ×¤× ×™, ×‘×™××™× ×¤×—×•×ª ×¢××•×¡×™×. ×”×× ×œ×©×‘×¥ ××•×ª×?`;
                document.getElementById('aiSuggestionText').innerText = text;
                suggestionBox.classList.remove('hidden');
            }
        }
    }

    function applyAiSuggestion() {
        const examTitle = document.getElementById('evtTitle').value || '×”××‘×—×Ÿ';
        proposedStudySlots.forEach(slot => {
            STATE.personalEvents.push({
                id: Date.now() + Math.random(),
                title: `×œ××™×“×” ×œ${examTitle}`,
                type: 'study',
                date: slot.date,
                time: slot.time,
                duration: slot.duration,
                isAuto: true,
                description: slot.reason
            });
        });
        document.getElementById('aiSuggestionBox').innerHTML = '<p style="color:green; font-weight:bold;">âœ… ×©×•×‘×¦×• ×©×¢×•×ª ×œ××™×“×” ×‘×”×¦×œ×—×”!</p>';
        setTimeout(() => document.getElementById('aiSuggestionBox').classList.add('hidden'), 2000);
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        
        const newEvent = {
            id: Date.now(),
            title: document.getElementById('evtTitle').value,
            type: document.getElementById('evtType').value,
            date: document.getElementById('evtDate').value,
            time: document.getElementById('evtTime').value,
            duration: document.getElementById('evtDuration').value,
            isAuto: false
        };

        STATE.personalEvents.push(newEvent);
        saveData();
        closeModal();
    }

    /**
     * Helpers
     */
    function addDays(dateStr, days) {
        const date = new Date(dateStr);
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    }

    function formatDateIL(dateStr) {
        const parts = dateStr.split('-');
        return `${parts[2]}/${parts[1]}`;
    }

    function getDayName(dateStr) {
        const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
        return days[new Date(dateStr).getDay()];
    }

    function getTypeName(type) {
        const types = { 'exam': '××‘×—×Ÿ', 'assignment': '××˜×œ×”', 'activity': '×¤×¢×™×œ×•×ª', 'study': '×œ××™×“×”' };
        return types[type] || type;
    }

    // Start App
    init();

</script>
</body>
</html>