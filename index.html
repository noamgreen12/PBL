<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent AI Planner Pro</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-light: #636e72;
            --safe: #00b894;
            --warning: #fdcb6e;
            --danger: #ff7675;
            --shadow: 0 8px 20px rgba(0,0,0,0.06);
            --radius: 16px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Layout */
        .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }
        
        /* Navigation */
        .nav-sidebar {
            background: var(--card-bg); width: 260px; display: none; flex-direction: column; padding: 25px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.03); z-index: 100;
        }
        .nav-bottom {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg);
            display: flex; justify-content: space-around; padding: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100; border-radius: 20px 20px 0 0;
        }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px;
            cursor: pointer; color: var(--text-light); transition: 0.2s; font-weight: 500;
        }
        .nav-item.active { background: #efeefc; color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 1.4rem; }

        /* Main Area */
        .main-content {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px;
            max-width: 1200px; margin: 0 auto; width: 100%;
        }

        /* Components */
        h1 { font-size: 1.8rem; margin-bottom: 5px; }
        h2 { font-size: 1.4rem; margin: 20px 0 10px 0; }
        .subtitle { color: var(--text-light); font-size: 0.9rem; margin-bottom: 20px; }

        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px;
            margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        
        /* Event List Styles */
        .event-item {
            display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f1f2f6;
            position: relative; align-items: flex-start;
        }
        .event-item:last-child { border-bottom: none; }
        .event-time-col {
            display: flex; flex-direction: column; align-items: center; min-width: 50px;
            font-weight: 700; color: var(--text); font-size: 0.9rem;
        }
        .event-content { flex: 1; }
        .event-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
        .event-meta { font-size: 0.8rem; color: var(--text-light); display: flex; gap: 8px; align-items: center; }
        
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        .tag-exam { background: #ffeaa7; color: #d35400; }
        .tag-study { background: #dfe6e9; color: #2d3436; border-left: 3px solid var(--primary); }
        .tag-auto { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; }

        /* AI Elements */
        .ai-status-card {
            background: linear-gradient(135deg, #6c5ce7 0%, #8e7bf3 100%);
            color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 25px;
            position: relative; overflow: hidden;
        }
        .ai-status-card::after {
            content: 'AI'; position: absolute; right: -10px; bottom: -20px;
            font-size: 8rem; opacity: 0.1; font-weight: 900;
        }
        .load-meter {
            height: 6px; background: rgba(255,255,255,0.3); border-radius: 10px; margin: 15px 0; overflow: hidden;
        }
        .load-fill { height: 100%; background: #00cec9; width: 0%; transition: 1s ease; }

        /* FAB & Modal */
        .fab {
            position: fixed; bottom: 90px; left: 20px; width: 60px; height: 60px;
            background: var(--text); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            box-shadow: 0 10px 25px rgba(45, 52, 54, 0.3); cursor: pointer; z-index: 101;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 52, 54, 0.6); backdrop-filter: blur(4px);
            z-index: 200; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 100%; max-width: 500px;
            border-radius: 24px 24px 0 0; padding: 25px;
            max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Form & Plan Styles */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text); }
        input, select {
            width: 100%; padding: 14px; border: 2px solid #f1f2f6; border-radius: 12px;
            font-size: 1rem; font-family: var(--font); transition: 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .ai-plan-box {
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 15px; margin-top: 15px;
            display: none; animation: fadeIn 0.5s;
        }
        .ai-plan-box.active { display: block; }
        .plan-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: var(--primary); font-weight: bold; }
        .plan-explanation { font-size: 0.9rem; line-height: 1.5; color: var(--text-light); margin-bottom: 15px; }
        .plan-slots { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .slot-chip {
            background: white; border: 1px solid #dfe6e9; padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; display: flex; align-items: center; gap: 5px;
        }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer; margin-bottom: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-magic { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; }
        .btn-ghost { background: transparent; color: var(--text-light); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        @media (min-width: 768px) {
            .nav-sidebar { display: flex; height: 100vh; }
            .nav-bottom { display: none; }
            .modal-overlay { align-items: center; }
            .modal-content { border-radius: 24px; padding: 40px; }
            .fab { left: 40px; bottom: 40px; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <nav class="nav-sidebar">
        <h2 style="color:var(--primary)">SmartStudent AI</h2>
        <div class="nav-item active" onclick="app.switchTab('dashboard')">
            <span class="nav-icon">âš¡</span> ×“××©×‘×•×¨×“
        </div>
        <div class="nav-item" onclick="app.switchTab('calendar')">
            <span class="nav-icon">ğŸ“…</span> ×”×™×•××Ÿ ×©×œ×™
        </div>
    </nav>

    <main class="main-content" id="viewContainer">
        </main>

    <nav class="nav-bottom">
        <div class="nav-item active" onclick="app.switchTab('dashboard')"><span class="nav-icon">âš¡</span></div>
        <div class="nav-item" onclick="app.switchTab('calendar')"><span class="nav-icon">ğŸ“…</span></div>
    </nav>
</div>

<div class="fab" onclick="ui.openModal()">+</div>

<div class="modal-overlay" id="eventModal">
    <div class="modal-content">
        <h2 id="modalTitle">×”×•×¡×¤×ª ××™×¨×•×¢</h2>
        
        <form id="eventForm" onsubmit="return false;">
            <div class="form-group">
                <label>×›×•×ª×¨×ª</label>
                <input type="text" id="evtTitle" placeholder="×©× ×”××™×¨×•×¢ / ××‘×—×Ÿ">
            </div>

            <div class="form-group">
                <label>×¡×•×’</label>
                <select id="evtType" onchange="ui.onTypeChange()">
                    <option value="activity">×¤×¢×™×œ×•×ª / ×—×•×’</option>
                    <option value="assignment">××˜×œ×”</option>
                    <option value="exam">××‘×—×Ÿ (×”×¤×¢×œ×ª AI Planner)</option>
                    <option value="school_overlay">××™×¨×•×¢ ×‘×™×ª ×¡×¤×¨</option>
                </select>
            </div>

            <div id="examFields" class="hidden">
                <div class="form-group">
                    <label>×¨××ª ×§×•×©×™ (×§×•×‘×¢ ×©×¢×•×ª ×”×›× ×”)</label>
                    <select id="evtDifficulty">
                        <option value="2">×§×œ (×©×¢×ª×™×™× ×”×›× ×”)</option>
                        <option value="4" selected>×‘×™× ×•× ×™ (4 ×©×¢×•×ª ×”×›× ×”)</option>
                        <option value="7">×§×©×” (7 ×©×¢×•×ª ×”×›× ×”)</option>
                        <option value="10">×§×¨×™×˜×™ (10 ×©×¢×•×ª ×”×›× ×”)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>×ª××¨×™×š</label>
                <input type="date" id="evtDate" required>
            </div>
            
            <div class="form-group" id="timeGroup">
                <label>×©×¢×”</label>
                <input type="time" id="evtTime" value="10:00">
            </div>

             <div class="form-group" id="durationGroup">
                <label>××©×š (×‘×©×¢×•×ª)</label>
                <input type="number" id="evtDuration" value="1" step="0.5" min="0.5">
            </div>

            <div id="aiPlannerArea" class="hidden">
                <button type="button" class="btn btn-magic" onclick="ai.generatePlan()">âœ¨ ×¦×•×¨ ×ª×•×›× ×™×ª ×œ×™××•×“ AI</button>
                
                <div id="aiResultBox" class="ai-plan-box">
                    <div class="plan-header">
                        <span>ğŸ¤– ×”××œ×¦×ª ×”××¢×¨×›×ª</span>
                    </div>
                    <div class="plan-explanation" id="aiExplanation"></div>
                    <div class="plan-slots" id="aiSlotsContainer"></div>
                    <div style="font-size:0.8rem; color: #ff7675; margin-bottom:10px;" id="aiWarning"></div>
                    
                    <button type="button" class="btn btn-primary" onclick="app.savePlan()">××©×¨ ×ª×•×›× ×™×ª ×•×”×•×¡×£ ×œ×™×•××Ÿ</button>
                    <button type="button" class="btn btn-ghost" onclick="ui.resetPlan()">×‘×˜×œ ×ª×›× ×•×Ÿ</button>
                </div>
            </div>

            <div id="standardButtons">
                <button type="button" class="btn btn-primary" onclick="app.saveStandardEvent()">×©××•×¨</button>
                <button type="button" class="btn btn-ghost" onclick="ui.closeModal()">×‘×™×˜×•×œ</button>
            </div>
        </form>
    </div>
</div>

<script>
/**
 * 1. Data Store & Configuration
 */
const DB = {
    key: 'smartStudentPro_v1',
    data: {
        events: []
    },
    load() {
        const stored = localStorage.getItem(this.key);
        if (stored) this.data = JSON.parse(stored);
        else this.seed();
    },
    save() {
        localStorage.setItem(this.key, JSON.stringify(this.data));
        app.render();
    },
    seed() {
        const today = new Date().toISOString().split('T')[0];
        this.data.events = [
            { id: 1, title: '×—×•×’ ×›×“×•×¨×¡×œ', type: 'activity', date: today, time: '16:00', duration: 1.5 },
            { id: 2, title: '×™×•× ×”×•×¨×™×', type: 'school_overlay', date: today, time: '18:00', duration: 2 }
        ];
        this.save();
    }
};

/**
 * 2. The Heuristic AI Engine
 */
const ai = {
    tempPlan: null, // Holds proposed slots before saving

    // Main Planner Function
    generatePlan() {
        const title = document.getElementById('evtTitle').value || '×”××‘×—×Ÿ';
        const examDateStr = document.getElementById('evtDate').value;
        const difficultyHours = parseFloat(document.getElementById('evtDifficulty').value);
        
        if (!examDateStr) { alert('× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×œ××‘×—×Ÿ'); return; }

        const examDate = new Date(examDateStr);
        const windowDays = 7; // Look back window
        let hoursNeeded = difficultyHours;
        let suggestedSlots = [];
        let messages = [];

        // Algorithm Loop: Go backwards from day before exam
        for (let i = 1; i <= windowDays; i++) {
            if (hoursNeeded <= 0) break;

            const targetDate = new Date(examDate);
            targetDate.setDate(targetDate.getDate() - i);
            const dateStr = targetDate.toISOString().split('T')[0];
            
            // Skip if date is in past
            if (new Date(dateStr) < new Date().setHours(0,0,0,0)) continue;

            // Get day's existing load
            const dayEvents = DB.data.events.filter(e => e.date === dateStr);
            const load = this.calculateDayLoad(dayEvents);

            // Hard constraints: Max daily load 6 hours
            if (load > 6) continue;

            // Find optimal slots in this day (16:00 - 21:00)
            const slots = this.findSlotsInDay(dateStr, dayEvents, hoursNeeded);
            
            slots.forEach(slot => {
                if (hoursNeeded > 0) {
                    suggestedSlots.push(slot);
                    hoursNeeded -= slot.duration;
                }
            });
        }

        // Logic for explanation
        let explanation = "";
        if (suggestedSlots.length === 0) {
            explanation = "×œ× × ××¦××• ×—×œ×•× ×•×ª ×–××Ÿ ×¤× ×•×™×™× ×‘×©×‘×•×¢ ×©×œ×¤× ×™ ×”××‘×—×Ÿ. ××•××œ×¥ ×œ×¤× ×•×ª ×–××Ÿ ×™×“× ×™×ª.";
        } else {
            explanation = `×™×© ×œ×œ××•×“ ${difficultyHours} ×©×¢×•×ª. ×”××¢×¨×›×ª ×¡×¨×§×” 7 ×™××™× ××—×•×¨×”.<br>`;
            
            // Humanize logic
            const dayCounts = {};
            suggestedSlots.forEach(s => {
                const day = ui.getDayName(s.date);
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            
            explanation += `×¤×™×–×¨×ª×™ ××ª ×”×œ××™×“×” ×¢×œ ×¤× ×™: <b>${Object.keys(dayCounts).join(', ')}</b> ×›×“×™ ×œ×× ×•×¢ ×¢×•××¡. × ×‘×—×¨×• ×©×¢×•×ª ×‘×”×Ÿ ××™×Ÿ ×”×ª× ×’×©×•×ª ×¢× ×¤×¢×™×œ×•×™×•×ª ××—×¨×•×ª.`;
        }

        // Store and Render
        this.tempPlan = {
            examEvent: {
                id: Date.now(),
                title: title,
                type: 'exam',
                date: examDateStr,
                time: document.getElementById('evtTime').value,
                duration: 1.5, // Exam duration default
                difficulty: difficultyHours
            },
            studyBlocks: suggestedSlots.map(s => ({
                id: Date.now() + Math.random(),
                title: `×œ××™×“×” ×œ${title}`,
                type: 'study',
                date: s.date,
                time: s.time,
                duration: s.duration,
                isAuto: true,
                linkedExamId: null // Set upon save
            }))
        };

        ui.renderPlanProposal(explanation, suggestedSlots, hoursNeeded > 0);
    },

    // Identify free slots in a specific day with Scoring
    findSlotsInDay(dateStr, dayEvents, maxHoursNeeded) {
        // Potential start times: 16:00 to 20:00 (every 30 mins)
        // Converted to minutes from midnight
        const startWindow = 16 * 60; 
        const endWindow = 21 * 60;
        const candidates = [];

        // Helper: Convert "HH:MM" to minutes
        const toMin = (t) => parseInt(t.split(':')[0]) * 60 + parseInt(t.split(':')[1]);

        // Scan every 30 min block
        for (let time = startWindow; time < endWindow; time += 30) {
            // Define a potential block (default 60 mins or remaining needed)
            let duration = Math.min(60, maxHoursNeeded * 60); 
            if (duration < 45) duration = 45; // Minimum study block

            const slotStart = time;
            const slotEnd = time + duration;

            // 1. Collision Check
            let collision = false;
            dayEvents.forEach(e => {
                const eStart = toMin(e.time);
                const eEnd = eStart + (e.duration * 60);
                // Overlap formula
                if (slotStart < eEnd && slotEnd > eStart) collision = true;
            });

            if (collision) continue;

            // 2. Scoring System
            let score = 100;
            
            // Prefer earlier in the evening (16:00-18:00)
            if (slotStart < 18 * 60) score += 20;
            
            // Penalize if adjacent to existing events (allow 30 min break)
            dayEvents.forEach(e => {
                const eEnd = toMin(e.time) + (e.duration * 60);
                if (Math.abs(slotStart - eEnd) < 30) score -= 30; // Too close to previous event
            });

            // Convert back to HH:MM
            const hh = Math.floor(slotStart / 60).toString().padStart(2,'0');
            const mm = (slotStart % 60).toString().padStart(2,'0');

            candidates.push({
                date: dateStr,
                time: `${hh}:${mm}`,
                duration: duration / 60,
                score: score
            });
        }

        // Sort by score and pick non-overlapping best ones
        candidates.sort((a,b) => b.score - a.score);
        
        // Simple heuristic: Take top 1, max 2 per day if really needed
        if (candidates.length > 0) return [candidates[0]];
        return [];
    },

    calculateDayLoad(events) {
        return events.reduce((sum, e) => sum + parseFloat(e.duration), 0);
    },

    getInsights() {
        const today = new Date().toISOString().split('T')[0];
        const dayEvents = DB.data.events.filter(e => e.date === today);
        const load = this.calculateDayLoad(dayEvents);
        
        let status = { text: '×¨×’×•×¢', color: 'safe', percent: 20 };
        if (load > 3) status = { text: '×¢××•×¡ ×‘×™× ×•× ×™', color: 'warning', percent: 50 };
        if (load > 6) status = { text: '×™×•× ×“×—×•×¡', color: 'danger', percent: 90 };

        const exams = DB.data.events.filter(e => e.type === 'exam' && e.date >= today);
        const nextExam = exams.sort((a,b) => new Date(a.date) - new Date(b.date))[0];

        return { load, status, nextExam };
    }
};

/**
 * 3. UI Controller
 */
const ui = {
    init() {
        DB.load();
        app.render();
    },

    onTypeChange() {
        const type = document.getElementById('evtType').value;
        const examFields = document.getElementById('examFields');
        const aiArea = document.getElementById('aiPlannerArea');
        const stdBtns = document.getElementById('standardButtons');
        const timeGroup = document.getElementById('timeGroup');
        const durGroup = document.getElementById('durationGroup');

        if (type === 'exam') {
            examFields.classList.remove('hidden');
            aiArea.classList.remove('hidden');
            stdBtns.classList.add('hidden'); // Hide standard save, enforce AI flow or manual later
            // Exam usually has fixed time, but duration is less relevant for "event" itself visually
        } else {
            examFields.classList.add('hidden');
            aiArea.classList.add('hidden');
            stdBtns.classList.remove('hidden');
            this.resetPlan();
        }
    },

    renderPlanProposal(text, slots, isPartial) {
        document.getElementById('aiResultBox').classList.add('active');
        document.getElementById('aiExplanation').innerHTML = text;
        
        const container = document.getElementById('aiSlotsContainer');
        container.innerHTML = '';
        slots.forEach(s => {
            container.innerHTML += `
                <div class="slot-chip">
                    <span>ğŸ“… ${this.getDayName(s.date)}</span>
                    <span>â° ${s.time}</span>
                    <span>â³ ${s.duration}×©'</span>
                </div>
            `;
        });

        const warning = document.getElementById('aiWarning');
        if (isPartial) {
            warning.innerText = "âš ï¸ ×©×™× ×œ×‘: ×¢×§×‘ ×¢×•××¡, ×œ× ×”×¦×œ×—× ×• ×œ×©×‘×¥ ××ª ×›×œ ×©×¢×•×ª ×”×”×›× ×” ×”× ×“×¨×©×•×ª.";
        } else {
            warning.innerText = "";
        }
    },

    resetPlan() {
        document.getElementById('aiResultBox').classList.remove('active');
        ai.tempPlan = null;
    },

    openModal() {
        document.getElementById('eventModal').classList.add('active');
        // Reset fields
        document.getElementById('evtDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('evtTitle').value = '';
        document.getElementById('evtType').value = 'activity';
        this.onTypeChange();
    },

    closeModal() {
        document.getElementById('eventModal').classList.remove('active');
    },

    getDayName(dateStr) {
        const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
        return days[new Date(dateStr).getDay()];
    },
    
    formatDate(dateStr) {
        const parts = dateStr.split('-');
        return `${parts[2]}/${parts[1]}`;
    }
};

/**
 * 4. App Controller (Logic Glue)
 */
const app = {
    view: 'dashboard',

    switchTab(view) {
        this.view = view;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Add active class logic here if needed
        this.render();
    },

    saveStandardEvent() {
        const newEvent = {
            id: Date.now(),
            title: document.getElementById('evtTitle').value || '×œ×œ× ×›×•×ª×¨×ª',
            type: document.getElementById('evtType').value,
            date: document.getElementById('evtDate').value,
            time: document.getElementById('evtTime').value,
            duration: parseFloat(document.getElementById('evtDuration').value),
            isAuto: false
        };
        DB.data.events.push(newEvent);
        DB.save();
        ui.closeModal();
    },

    savePlan() {
        if (!ai.tempPlan) return;
        
        // Save the Exam
        const exam = ai.tempPlan.examEvent;
        DB.data.events.push(exam);

        // Save the Study Blocks (linked)
        ai.tempPlan.studyBlocks.forEach(block => {
            block.linkedExamId = exam.id;
            DB.data.events.push(block);
        });

        DB.save();
        ui.closeModal();
    },

    render() {
        const container = document.getElementById('viewContainer');
        container.innerHTML = '';

        if (this.view === 'dashboard') this.renderDashboard(container);
        else this.renderCalendar(container);
    },

    renderDashboard(container) {
        const insights = ai.getInsights();
        const upcomingEvents = DB.data.events
            .filter(e => new Date(e.date) >= new Date().setHours(0,0,0,0))
            .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time))
            .slice(0, 5);

        let html = `
            <h1>×©×œ×•×, ××œ×•×£ ğŸ“</h1>
            <p class="subtitle">×”× ×” ×ª××•× ×ª ×”××¦×‘ ×©×œ×š ×œ×”×™×•×</p>

            <div class="ai-status-card">
                <h3>××¦×‘ ×¢×•××¡ ×™×•××™: ${insights.status.text}</h3>
                <div class="load-meter">
                    <div class="load-fill" style="width: ${insights.status.percent}%; background-color: var(--${insights.status.color})"></div>
                </div>
                <p style="font-size:0.9rem; opacity:0.9">
                    ${insights.nextExam ? `ğŸ¯ ×”××˜×¨×” ×”×‘××”: ××‘×—×Ÿ ×‘${insights.nextExam.title} ×‘-${ui.formatDate(insights.nextExam.date)}` : '××™×Ÿ ××‘×—× ×™× ×§×¨×•×‘×™×. ×–××Ÿ ×˜×•×‘ ×œ× ×•×—!'}
                </p>
            </div>

            <h2>×”××™×¨×•×¢×™× ×”×§×¨×•×‘×™×</h2>
        `;

        upcomingEvents.forEach(e => {
            html += this.createEventCard(e);
        });

        if(upcomingEvents.length === 0) html += '<p style="text-align:center; margin-top:20px;">×”×™×•××Ÿ ×¨×™×§ ×œ×—×œ×•×˜×™×Ÿ ğŸ˜</p>';

        container.innerHTML = html;
    },

    renderCalendar(container) {
        // Group by Date
        const grouped = {};
        const dates = [];
        
        // Sort all events
        const sorted = [...DB.data.events].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        sorted.forEach(e => {
            if(!grouped[e.date]) {
                grouped[e.date] = [];
                dates.push(e.date);
            }
            grouped[e.date].push(e);
        });

        // Generate HTML
        let html = '<h2>×”×™×•××Ÿ ×”××œ×</h2>';
        dates.forEach(date => {
            // Check if date is passed
            const isPast = new Date(date) < new Date().setHours(0,0,0,0);
            const style = isPast ? 'opacity: 0.6; filter: grayscale(1);' : '';
            
            html += `<div style="${style}">
                <h3 style="margin-top:20px; font-size:1rem; color:var(--primary)">${ui.getDayName(date)} ${ui.formatDate(date)}</h3>
            `;
            
            // Sort by time within day
            grouped[date].sort((a,b) => a.time.localeCompare(b.time));
            
            grouped[date].forEach(e => {
                html += this.createEventCard(e);
            });
            html += '</div>';
        });

        container.innerHTML = html;
    },

    createEventCard(e) {
        let tagClass = 'tag-study';
        let label = '××™×¨×•×¢';
        
        if (e.type === 'exam') { tagClass = 'tag-exam'; label = '××‘×—×Ÿ'; }
        else if (e.isAuto) { tagClass = 'tag-auto'; label = 'AI Planner'; }
        else if (e.type === 'school_overlay') { label = '×‘×™"×¡'; }

        return `
            <div class="event-item">
                <div class="event-time-col">
                    <span>${e.time}</span>
                    <span style="font-size:0.7rem; font-weight:400">${e.duration}×©'</span>
                </div>
                <div class="event-content">
                    <div class="event-title">${e.title}</div>
                    <div class="event-meta">
                        <span class="tag ${tagClass}">${label}</span>
                        ${e.isAuto ? '<span>âœ¨ × ×•×¦×¨ ××•×˜×•××˜×™×ª</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    }
};

// Start
ui.init();
</script>

</body>
</html>