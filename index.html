<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent App</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --exam: #ef4444;
            --study: #f59e0b;
            --school: #0ea5e9;
            --radius: 20px;
            --nav-h: 70px;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; 
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- Layout Structures --- */
        .sidebar {
            width: var(--sidebar-w); background: var(--card); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 24px; z-index: 1000;
        }
        .main-content { flex: 1; overflow-y: auto; padding: 24px; position: relative; scroll-behavior: smooth; }
        
        /* Mobile vs Desktop Display */
        @media (max-width: 600px) {
            .sidebar { display: none; }
            .desktop-only { display: none !important; }
            .main-content { padding: 16px 16px 100px 16px; }
        }
        @media (min-width: 601px) {
            .bottom-nav { display: none !important; }
            .mobile-only { display: none !important; }
        }

        /* --- Dashboard --- */
        .dashboard { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 16px; margin-bottom: 24px; 
        }
        .stat-card { 
            background: var(--card); padding: 16px; border-radius: var(--radius); 
            border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .stat-card span { font-size: 0.8rem; color: var(--muted); font-weight: 700; display: block; margin-bottom: 4px; }
        .stat-card strong { font-size: 1.2rem; color: var(--primary); }

        /* --- Calendar Logic --- */
        .calendar-card { background: var(--card); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; cursor: pointer; font-size: 0.9rem; position: relative;
            min-height: 44px; /* Touch target size */
        }
        .day.selected { background: var(--primary); color: white; }
        .day.today { border: 2px solid var(--primary); font-weight: 800; }
        .marker-dot { width: 5px; height: 5px; border-radius: 50%; position: absolute; bottom: 6px; }

        /* --- Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card);
            height: var(--nav-h); display: flex; justify-content: space-around;
            padding: 10px; border-top: 1px solid var(--border); z-index: 2000;
        }
        .nav-item { border: none; background: none; color: var(--muted); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* --- Bottom Sheet (Mobile) / Modal (Desktop) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; z-index: 3000;
        }
        .modal-container {
            position: absolute; background: white; transition: 0.3s transform ease-out;
        }
        @media (max-width: 600px) {
            .modal-container { bottom: 0; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); }
            .modal-overlay.active .modal-container { transform: translateY(0); }
        }
        @media (min-width: 601px) {
            .modal-container { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; border-radius: 24px; padding: 30px; }
        }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 6px; color: var(--muted); }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; background: #fff; }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }

        /* --- Lists --- */
        .event-item {
            display: flex; align-items: center; padding: 14px; background: #fff; 
            border-radius: 16px; margin-bottom: 10px; border-right: 5px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .ev-exam { border-right-color: var(--exam); }
        .ev-study { border-right-color: var(--study); background: #fffdf2; }

        /* Utilities */
        .hidden { display: none; }
        #toast { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; display: none; z-index: 4000; }
    </style>
</head>
<body onload="initApp()">

    <aside class="sidebar desktop-only">
        <h2 style="color:var(--primary); margin-bottom:40px;">SmartStudent</h2>
        <button class="nav-item active" style="flex:none; flex-direction:row; gap:12px; padding:15px; font-size:1rem;" onclick="switchTab('personal')">ğŸ  <span>×”×™×•××Ÿ ×©×œ×™</span></button>
        <button class="nav-item" style="flex:none; flex-direction:row; gap:12px; padding:15px; font-size:1rem;" onclick="switchTab('school')">ğŸ« <span>×‘×™×ª ×¡×¤×¨</span></button>
    </aside>

    <main class="main-content">
        <div class="dashboard">
            <div class="stat-card"><span>×”×™×•×</span><strong id="stat-today">0</strong></div>
            <div class="stat-card"><span>×”××‘×—×Ÿ ×”×§×¨×•×‘</span><strong id="stat-exam">--</strong></div>
            <div class="stat-card"><span>×¢×•××¡ ×©×‘×•×¢×™</span><strong id="stat-week">0</strong></div>
            <div class="stat-card"><span>×–××Ÿ ×¤× ×•×™</span><strong id="stat-free">8×©'</strong></div>
        </div>

        <div id="page-personal" class="page active">
            <div class="calendar-card">
                <div class="cal-header">
                    <button onclick="changeMonth(-1)" style="border:none;background:none;font-size:1.2rem;cursor:pointer;">â–¶</button>
                    <strong id="monthYearLabel"></strong>
                    <button onclick="changeMonth(1)" style="border:none;background:none;font-size:1.2rem;cursor:pointer;">â—€</button>
                </div>
                <div class="cal-grid" id="calendarGrid" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)"></div>
            </div>

            <h3 style="margin-top:25px;">×”×œ×•"×– ×œ-<span id="selectedDateLabel"></span></h3>
            <div id="dailyAgenda"></div>
        </div>

        <div id="page-school" class="page hidden">
            <h3 style="color:var(--primary)">ğŸ« ×œ×•×— ××™×¨×•×¢×™× ×©×›×‘×ª×™ (×¢× ×Ÿ)</h3>
            <div id="schoolEventList"></div>
        </div>
    </main>

    <nav class="bottom-nav mobile-only">
        <button class="nav-item active" onclick="switchTab('personal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>×™×•××Ÿ</span></button>
        <button class="nav-item" onclick="openModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span>×”×•×¡×¤×”</span></button>
        <button class="nav-item" onclick="switchTab('school')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg><span>×‘×™"×¡</span></button>
    </nav>

    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target==this) closeModal()">
        <div class="modal-container">
            <h3 id="modalTitle">×¤×¢×™×œ×•×ª ×—×“×©×”</h3>
            <div class="form-group">
                <label>× ×•×©×</label>
                <input type="text" id="eventTitle" placeholder="×œ××©×œ: ××‘×—×Ÿ ×‘×ª× ×´×š">
            </div>
            <div style="display:flex; gap:12px;">
                <div class="form-group" style="flex:1">
                    <label>×¡×•×’</label>
                    <select id="eventType">
                        <option value="××‘×—×Ÿ">××‘×—×Ÿ</option>
                        <option value="×©×™×¢×•×¨×™×">×©×™×¢×•×¨×™×</option>
                        <option value="×¤×¢×™×œ×•×ª">×¤×¢×™×œ×•×ª</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>×›×™×ª×”</label>
                    <select id="eventClass">
                        <option>×™'1</option><option>×™'2</option><option>×™'3</option><option>×™'4</option><option>×™'5</option>
                    </select>
                </div>
            </div>
            <button class="btn-main" onclick="handleSave()">×©××•×¨ ×‘×œ×•×—</button>
            <button class="mobile-only btn-main" style="background:none; color:var(--muted); margin-top:8px;" onclick="closeModal()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- Configuration ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjUOZw7k1RUW9HArAZPEpdX7L1HP5jpMGasjeFC0jwNSylvDLUEyYQUqIq46YhEpTu/exec";
        let personalEvents = JSON.parse(localStorage.getItem('student_personal_v8')) || [];
        let sharedEvents = [];
        let viewDate = new Date();
        let selectedDate = new Date();
        let viewMode = window.innerWidth < 600 ? 'week' : 'month';

        // --- Core Functions ---
        function initApp() {
            renderCalendar();
            renderDashboard();
            renderDaily();
            loadSharedData();
            
            // Keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                if(e.key.toLowerCase() === 'n') openModal();
                if(e.key === 'ArrowRight') changeMonth(-1);
                if(e.key === 'ArrowLeft') changeMonth(1);
            });
        }

        async function loadSharedData() {
            if(SCRIPT_URL.includes("×›××Ÿ_××“×‘×™×§×™×")) return;
            try {
                const res = await fetch(SCRIPT_URL);
                sharedEvents = await res.json();
                renderCalendar();
                renderDaily();
                renderDashboard();
                renderSchoolList();
            } catch(e) { console.error(e); }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('monthYearLabel');
            grid.innerHTML = '';
            
            label.innerText = viewDate.toLocaleDateString('he-IL', { month:'long', year:'numeric'});
            ['×','×‘','×’','×“','×”','×•','×©'].forEach(d => grid.innerHTML += `<div style="font-weight:700; color:var(--muted); font-size:0.75rem;">${d}</div>`);

            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month+1, 0).getDate();

            if(viewMode === 'month') {
                for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
                for(let d=1; d<=daysInMonth; d++) {
                    createDayElement(grid, year, month, d);
                }
            } else {
                // Weekly view for mobile (current week of viewDate)
                let startOfWeek = new Date(viewDate);
                startOfWeek.setDate(viewDate.getDate() - viewDate.getDay());
                for(let i=0; i<7; i++) {
                    let d = new Date(startOfWeek); d.setDate(startOfWeek.getDate() + i);
                    createDayElement(grid, d.getFullYear(), d.getMonth(), d.getDate());
                }
            }
        }

        function createDayElement(grid, y, m, d) {
            const date = new Date(y, m, d);
            const time = date.toDateString();
            const isSelected = time === selectedDate.toDateString();
            const isToday = time === new Date().toDateString();
            
            const hasShared = sharedEvents.some(e => new Date(e.date).toDateString() === time);
            const hasPersonal = personalEvents.some(e => new Date(e.date).toDateString() === time);

            const div = document.createElement('div');
            div.className = `day ${isSelected ? 'selected' : ''} ${isToday ? 'today' : ''}`;
            div.innerText = d;
            div.onclick = () => { selectedDate = new Date(y, m, d); renderCalendar(); renderDaily(); };
            
            if(hasShared || hasPersonal) {
                const dot = document.createElement('div');
                dot.className = 'marker-dot';
                dot.style.background = hasShared ? 'var(--exam)' : 'var(--primary)';
                div.appendChild(dot);
            }
            grid.appendChild(div);
        }

        function renderDaily() {
            const list = document.getElementById('dailyAgenda');
            const label = document.getElementById('selectedDateLabel');
            label.innerText = selectedDate.toLocaleDateString('he-IL', {day:'numeric', month:'short'});
            list.innerHTML = '';
            
            const timeStr = selectedDate.toDateString();
            const combined = [
                ...sharedEvents.filter(e => new Date(e.date).toDateString() === timeStr),
                ...personalEvents.filter(e => new Date(e.date).toDateString() === timeStr)
            ];

            if(combined.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted)">×™×•× ×—×•×¤×©×™ - ×ª×”× ×•!</div>`;
                return;
            }

            combined.forEach(ev => {
                list.innerHTML += `
                    <div class="event-item ${ev.type === '××‘×—×Ÿ' ? 'ev-exam' : ''}">
                        <div style="flex:1">
                            <strong>${ev.title}</strong>
                            <span style="font-size:0.75rem; color:var(--muted)">${ev.classId || '××™×©×™'} | ${ev.type}</span>
                        </div>
                    </div>`;
            });
        }

        function handleSave() {
            const title = document.getElementById('eventTitle').value;
            if(!title) return showToast("× × ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª");
            
            // Logic: If personal page is active, save locally. Else sync to cloud.
            const isActivePagePersonal = !document.getElementById('page-personal').classList.contains('hidden');
            
            if(isActivePagePersonal) {
                personalEvents.push({
                    title, date: selectedDate.toISOString(), 
                    type: document.getElementById('eventType').value
                });
                localStorage.setItem('student_personal_v8', JSON.stringify(personalEvents));
                showToast("× ×©××¨ ×‘×™×•××Ÿ ×”××™×©×™!");
            } else {
                syncToCloud(title);
            }
            
            closeModal();
            refreshAll();
        }

        async function syncToCloud(title) {
            showToast("××¢×“×›×Ÿ ×¢× ×Ÿ...");
            await fetch(SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                body: JSON.stringify({
                    action: "add", title, date: selectedDate.toISOString(),
                    type: document.getElementById('eventType').value,
                    classId: document.getElementById('eventClass').value
                })
            });
            setTimeout(loadSharedData, 1500);
        }

        // --- Helpers & UI ---
        function switchTab(tab) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            refreshAll();
        }

        function openModal() { document.getElementById('modalOverlay').style.display = 'block'; setTimeout(() => document.getElementById('modalOverlay').classList.add('active'), 10); }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); setTimeout(() => document.getElementById('modalOverlay').style.display = 'none', 300); }
        function changeMonth(delta) { 
            if(viewMode === 'month') viewDate.setMonth(viewDate.getMonth() + delta);
            else viewDate.setDate(viewDate.getDate() + (delta * 7));
            renderCalendar(); 
        }
        function refreshAll() { renderCalendar(); renderDaily(); renderDashboard(); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none',3000); }
        
        // Touch Swipe logic
        let touchStartX = 0;
        function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
        function handleTouchEnd(e) { 
            const diff = e.changedTouches[0].screenX - touchStartX;
            if(Math.abs(diff) > 50) changeMonth(diff > 0 ? -1 : 1);
        }

        function renderDashboard() {
            const todayCount = [...sharedEvents, ...personalEvents].filter(e => new Date(e.date).toDateString() === new Date().toDateString()).length;
            document.getElementById('stat-today').innerText = todayCount;
            const exams = sharedEvents.filter(e => e.type === '××‘×—×Ÿ' && new Date(e.date) >= new Date());
            document.getElementById('stat-exam').innerText = exams.length > 0 ? exams[0].title : '--';
        }
    </script>
</body>
</html>