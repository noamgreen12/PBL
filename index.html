<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent Pro v11.0 - AI Planner Restored</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #eef2ff;
            --secondary: #3f37c9;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #212529;
            --text-muted: #6c757d;
            --safe: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e71d36;
            --school: #7209b7;
            --school-light: #f3e5f5;
            
            /* Tag Colors */
            --tag-exam: #fff176; --tag-exam-text: #f57f17;
            --tag-activity: #80deea; --tag-activity-text: #006064;
            --tag-trip: #e1bee7; --tag-trip-text: #4a148c;
            --tag-lesson: #90caf9; --tag-lesson-text: #0d47a1;
            
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Layout --- */
        .app-container { display: flex; height: 100%; width: 100%; }
        
        .sidebar {
            width: 260px; background: var(--card-bg); padding: 25px;
            display: none; flex-direction: column; gap: 10px;
            border-left: 1px solid rgba(0,0,0,0.05); z-index: 10;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: var(--card-bg); display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100;
            border-radius: 20px 20px 0 0;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 12px;
            transition: 0.2s; font-size: 0.8rem; font-weight: 500;
        }
        .nav-item.active { color: var(--primary); background: var(--primary-light); }
        .sidebar .nav-item { flex-direction: row; justify-content: flex-start; font-size: 1rem; padding: 12px; }

        /* --- Main Content --- */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; max-width: 1200px; margin: 0 auto; width: 100%; }

        h1, h2, h3 { margin: 0; }
        h2 { font-size: 1.25rem; margin-bottom: 15px; color: var(--text); }
        
        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 16px;
            margin-bottom: 16px; box-shadow: var(--shadow); position: relative;
            border: 1px solid rgba(0,0,0,0.02); transition: transform 0.2s;
        }

        /* --- CALENDAR COMPONENTS --- */
        .cal-controls {
            background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .cal-top-row { display: flex; justify-content: space-between; align-items: center; }
        .cal-nav-group { display: flex; gap: 8px; align-items: center; }
        .cal-title { font-weight: bold; font-size: 1.1rem; min-width: 120px; text-align: center; }
        
        .view-switcher {
            display: flex; background: #f1f3f5; padding: 4px; border-radius: 8px;
            overflow: hidden; width: 100%;
        }
        .view-btn {
            flex: 1; padding: 6px; text-align: center; font-size: 0.85rem; cursor: pointer;
            border-radius: 6px; color: var(--text-muted); transition: 0.2s;
        }
        .view-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 50%; cursor: pointer; border: 1px solid #dee2e6; }
        .btn-today { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; background: var(--primary-light); color: var(--primary); border: none; font-weight: bold; cursor: pointer; }

        /* --- GRIDS --- */
        .cal-tag {
            font-size: 0.75rem; padding: 4px; border-radius: 4px; margin-bottom: 2px;
            cursor: pointer; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
            border-right: 3px solid rgba(0,0,0,0.1);
        }
        .ct-exam { background: var(--tag-exam); color: var(--tag-exam-text); }
        .ct-study { background: var(--tag-lesson); color: var(--tag-lesson-text); }
        .ct-activity { background: var(--tag-activity); color: var(--tag-activity-text); }
        .ct-school { background: var(--tag-trip); color: var(--tag-trip-text); }

        /* Month */
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .month-header-cell { text-align: center; font-size: 0.8rem; font-weight: bold; color: var(--text-muted); padding: 5px 0; }
        .month-day {
            background: white; border: 1px solid #eee; border-radius: 8px; min-height: 80px; padding: 4px;
            display: flex; flex-direction: column; cursor: pointer;
        }
        .month-day.today { border: 2px solid var(--primary); }
        .month-day-num { font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; text-align: left; }
        .month-day.other-month { opacity: 0.4; background: #f9f9f9; }

        /* Week */
        .week-grid-container { overflow-x: auto; }
        .week-grid { display: grid; grid-template-columns: repeat(7, minmax(120px, 1fr)); gap: 6px; min-width: 800px; }
        .week-col { background: white; border: 1px solid #eee; border-radius: 8px; min-height: 200px; display: flex; flex-direction: column; }
        .week-header { background: #f8f9fa; padding: 8px; text-align: center; font-weight: bold; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .week-body { padding: 5px; flex: 1; display: flex; flex-direction: column; gap: 4px; }

        /* Day */
        .day-view-list { display: flex; flex-direction: column; gap: 10px; }
        .day-time-slot { display: flex; gap: 15px; padding: 10px; border-bottom: 1px solid #eee; background: white; border-radius: 8px; }
        .dt-time { font-weight: bold; width: 50px; color: var(--primary); }

        /* Year */
        .year-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .year-month { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .year-month:hover { border-color: var(--primary); background: var(--primary-light); }
        
        /* --- SYNC --- */
        .sync-box { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius: var(--radius); padding: 15px; margin-bottom: 20px; }
        .input-group-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .input-group-row select, .input-group-row input { flex: 1; margin:0; padding:10px; border:1px solid #ddd; border-radius:8px; }

        /* --- AI PLANNER UI --- */
        .ai-proposal-card {
            background: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 15px; margin-top: 10px;
        }
        .ai-proposal-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .ai-proposal-item {
            background: white; border: 1px solid #b8daff; color: #004085;
            padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;
        }
        .ai-message { font-size: 0.95rem; line-height: 1.5; color: #004085; margin-bottom: 10px; }

        /* --- Modals & Global --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        
        .error-box { background: #ffe3e3; border: 1px solid #ffc9c9; color: #c0392b; padding: 12px; border-radius: 10px; margin-top: 15px; display: none; }
        .fab { position: fixed; bottom: 90px; left: 20px; width: 56px; height: 56px; background: var(--text); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 150; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-magic { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (min-width: 768px) {
            .sidebar { display: flex; } .bottom-nav { display: none; }
            .fab { left: 50%; margin-left: -400px; bottom: 40px; } 
            .modal-overlay { align-items: center; } .modal-content { border-radius: 24px; padding: 40px; }
            .year-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo">SmartStudent Pro</div>
        <div class="nav-item active" onclick="app.navigate('dashboard')"><i>âš¡</i> ×“××©×‘×•×¨×“</div>
        <div class="nav-item" onclick="app.navigate('calendar')"><i>ğŸ“…</i> ×”×™×•××Ÿ ×©×œ×™</div>
        <div class="nav-item" onclick="app.navigate('school')"><i>ğŸ«</i> ×œ×•×— ×‘×™×ª ×¡×¤×¨</div>
    </aside>

    <main class="main-content" id="viewContainer"></main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="app.navigate('dashboard')"><i>âš¡</i><span>×“××©×‘×•×¨×“</span></div>
        <div class="nav-item" onclick="app.navigate('calendar')"><i>ğŸ“…</i><span>×™×•××Ÿ</span></div>
        <div class="nav-item" onclick="app.navigate('school')"><i>ğŸ«</i><span>×‘×™×”"×¡</span></div>
    </nav>
</div>

<div class="fab" onclick="ui.openAddModal()">+</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <h2>×”×•×¡×¤×ª ××™×¨×•×¢</h2>
        <div id="conflictError" class="error-box">
            <strong>âš ï¸ ×”×ª× ×’×©×•×ª ×‘×–××Ÿ!</strong> <span id="conflictMsg"></span>
            <div id="conflictSuggestions" style="display:flex; gap:5px; margin-top:5px; flex-wrap:wrap;"></div>
        </div>
        <form onsubmit="return false;">
            <label style="display:block;margin-top:10px">×›×•×ª×¨×ª</label>
            <input type="text" id="addTitle" placeholder="×©× ×”××™×¨×•×¢..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
            <label style="display:block;margin-top:10px">×¡×•×’</label>
            <select id="addType" onchange="ui.toggleExamFields()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
                <option value="activity">×¤×¢×™×œ×•×ª / ×—×•×’</option>
                <option value="assignment">××˜×œ×”</option>
                <option value="exam">××‘×—×Ÿ (AI Planner)</option>
            </select>
            <div id="examFields" class="hidden" style="background:#f0f4ff;padding:10px;border-radius:8px;margin-top:10px">
                <label>×¨××ª ×§×•×©×™ (AI)</label>
                <select id="addDifficulty" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd">
                    <option value="2">×§×œ (2 ×©×¢×•×ª)</option>
                    <option value="4" selected>×‘×™× ×•× ×™ (4 ×©×¢×•×ª)</option>
                    <option value="7">×§×©×” (7 ×©×¢×•×ª)</option>
                </select>
            </div>
            <label style="display:block;margin-top:10px">×ª××¨×™×š</label>
            <input type="date" id="addDate" required style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
            <label style="display:block;margin-top:10px">×©×¢×”</label>
            <input type="time" id="addTime" value="16:00" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
            <label style="display:block;margin-top:10px">××©×š (×©×¢×•×ª)</label>
            <input type="number" id="addDuration" value="1" step="0.5" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
            <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="logic.handleAddEvent()">×©××•×¨</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:5px" onclick="ui.closeModals()">×‘×™×˜×•×œ</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="aiModal">
    <div class="modal-content">
        <h2>ğŸ¤– ×ª×•×›× ×™×ª ×œ×™××•×“ ××•×¦×¢×ª</h2>
        <div class="ai-proposal-card">
            <div id="aiMessage" class="ai-message"></div>
            <div id="aiBlocksList" class="ai-proposal-list"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px; flex-direction:column;">
            <button class="btn btn-magic" onclick="logic.ai.confirmPlan()">âœ… ××©×¨ ×ª×•×›× ×™×ª ×•×©××•×¨</button>
            <button class="btn btn-ghost" onclick="logic.ai.retryPlan()">ğŸ² × ×¡×” ×©×¢×•×ª ××—×¨×•×ª</button>
            <button class="btn btn-ghost" onclick="logic.ai.cancelPlan()">×©××•×¨ ×œ×œ× ×ª×›× ×•×Ÿ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="viewModal">
    <div class="modal-content">
        <h2 id="viewTitle"></h2>
        <div style="margin-bottom:20px; color:var(--text-muted);">
            <div>ğŸ“… <span id="viewDate"></span></div>
            <div>â° <span id="viewTime"></span></div>
            <div>â³ <span id="viewDuration"></span></div>
            <div id="viewType" style="margin-top:10px;"></div>
        </div>
        
        <div id="aiActions" style="display:none; margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-magic" style="width:100%; font-size:0.9rem;" onclick="logic.ai.planFromView()">ğŸ“… ×ª×›× ×Ÿ ×œ××™×“×” ×œ××‘×—×Ÿ ×–×”</button>
        </div>
        <div id="aiDeleteActions" style="display:none; margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
             <button class="btn btn-ghost" style="width:100%; font-size:0.9rem; color:#e67e22" onclick="logic.ai.deletePlanFromView()">ğŸ—‘ï¸ ××—×§ ×¨×§ ××ª ×ª×•×›× ×™×ª ×”×œ××™×“×”</button>
        </div>

        <p id="viewDesc" style="background:#f8f9fa; padding:10px; border-radius:8px; display:none;"></p>
        <button class="btn btn-primary" style="width:100%" onclick="ui.closeModals()">×¡×’×•×¨</button>
        <button id="btnDelete" class="btn btn-ghost" style="width:100%; color:red; margin-top:10px;" onclick="">ğŸ—‘ï¸ ××—×§ ××™×¨×•×¢</button>
    </div>
</div>

<script>
/** CONFIG */
const SCHOOL_SHEETS = {
  "×©×›×‘×” ×™'": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSP8oTf-RKjlz-mNdYr0GQEuC40O7zp-FAtj-ZAfm-rS-azOuCckXB0PyP3cOYzML3ovjuum79jYRuq/pub?output=csv", 
};

/** STATE & DB */
const DB = {
    key: 'smartStudentV11',
    data: { 
        personalEvents: [], schoolEvents: [], schoolSheetUrl: '', selectedSheetKey: '', lastSync: null,
        calendarView: 'week', calendarAnchor: Date.now(),
        schoolView: 'week', schoolAnchor: Date.now()
    },
    
    init() {
        const stored = localStorage.getItem(this.key);
        if (stored) {
            this.data = JSON.parse(stored);
            if (!this.data.schoolEvents) this.data.schoolEvents = [];
            if (!this.data.calendarView) this.data.calendarView = 'week';
            if (this.data.schoolSheetUrl && (!this.data.lastSync || Date.now() - this.data.lastSync > 21600000)) {
                logic.syncFromSheets(this.data.schoolSheetUrl, true);
            }
        } else {
            this.seed();
        }
    },
    
    save() {
        localStorage.setItem(this.key, JSON.stringify(this.data));
    },

    seed() {
        const today = new Date().toISOString().split('T')[0];
        this.data.personalEvents = [];
        this.save();
    },

    deleteEvent(id) {
        // Delete linked study blocks first
        const isExam = this.data.personalEvents.find(e => e.id == id && e.type === 'exam');
        if (isExam) this.data.personalEvents = this.data.personalEvents.filter(e => e.linkedExamId != id);
        this.data.personalEvents = this.data.personalEvents.filter(e => e.id != id);
        this.save();
        ui.closeModals();
        app.render(); 
    }
};

/** LOGIC */
const logic = {
    addDays(d, n) { const date = new Date(d); date.setDate(date.getDate() + n); return date; },
    formatDateIL(d) { const [y,m,day]=d.split('-'); return `${day}/${m}`; },
    getDayName(d) { return ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'][new Date(d).getDay()]; },
    toMin(t) { if(!t)return 0; const[h,m]=t.split(':').map(Number); return h*60+m; },
    toTimeStr(min) { const h = Math.floor(min/60).toString().padStart(2,'0'); const m = (min%60).toString().padStart(2,'0'); return `${h}:${m}`; },

    navCalendar(direction, mode) {
        const keyAnchor = mode === 'school' ? 'schoolAnchor' : 'calendarAnchor';
        const keyView = mode === 'school' ? 'schoolView' : 'calendarView';
        const d = new Date(DB.data[keyAnchor]);
        const view = DB.data[keyView];
        if (view === 'day') d.setDate(d.getDate() + direction);
        else if (view === 'week') d.setDate(d.getDate() + (direction * 7));
        else if (view === 'month') d.setMonth(d.getMonth() + direction);
        else if (view === 'year') d.setFullYear(d.getFullYear() + direction);
        DB.data[keyAnchor] = d.getTime();
        DB.save();
        app.render();
    },
    
    setView(view, mode) {
        const keyView = mode === 'school' ? 'schoolView' : 'calendarView';
        DB.data[keyView] = view;
        DB.save();
        app.render();
    },
    
    jumpToToday(mode) {
        const keyAnchor = mode === 'school' ? 'schoolAnchor' : 'calendarAnchor';
        DB.data[keyAnchor] = Date.now();
        DB.save();
        app.render();
    },
    
    jumpToMonth(m, y, mode) {
        const d = new Date(); d.setFullYear(y); d.setMonth(m); d.setDate(1);
        const keyAnchor = mode === 'school' ? 'schoolAnchor' : 'calendarAnchor';
        const keyView = mode === 'school' ? 'schoolView' : 'calendarView';
        DB.data[keyAnchor] = d.getTime();
        DB.data[keyView] = 'month';
        DB.save();
        app.render();
    },

    handleSheetSelection(key) {
        if (!key) return;
        const url = SCHOOL_SHEETS[key];
        DB.data.selectedSheetKey = key;
        DB.data.schoolSheetUrl = url;
        DB.save();
        this.syncFromSheets(url, false);
    },

    async syncFromSheets(rawUrl, isAuto) {
        if(!rawUrl) return;
        let url = rawUrl;
        if(rawUrl.includes('/d/') && !rawUrl.includes('output=csv')) {
             const m = rawUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
             if(m) url = `https://docs.google.com/spreadsheets/d/${m[1]}/export?format=csv`;
        }
        try {
            const res = await fetch(url);
            if(!res.ok) throw new Error('Err');
            const txt = await res.text();
            const evts = this.parseCSV(txt);
            if(evts.length) {
                DB.data.schoolEvents = [...DB.data.schoolEvents.filter(e=>e.source!=='google_sheets'), ...evts];
                DB.data.lastSync = Date.now();
                DB.save();
                if(!isAuto && app.currentPage==='school') app.render();
                if(!isAuto) alert('âœ… ×¡× ×›×¨×•×Ÿ ×”×¦×œ×™×—!');
            }
        } catch(e) { console.error(e); if(!isAuto) alert('âŒ ×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ'); }
    },

    parseCSV(txt) {
        const rows = txt.split(/\r?\n/);
        const h = rows[0].toLowerCase().split(',').map(s=>s.trim().replace(/"/g,''));
        const idx = { t: h.indexOf('title'), dt: h.indexOf('date'), tm: h.indexOf('time'), ty: h.indexOf('type') };
        if(idx.t<0 || idx.dt<0) return [];
        return rows.slice(1).map((r, i) => {
            const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').trim());
            if(c.length<3) return null;
            if(!c[idx.t] || isNaN(new Date(c[idx.dt]).getTime())) return null;
            return {
                id: `sheet_${i}_${Date.now()}`,
                title: c[idx.t], date: c[idx.dt], time: c[idx.tm]||'', type: c[idx.ty]||'school', duration: 1, source: 'google_sheets'
            };
        }).filter(Boolean);
    },

    checkConflict(newE, extraEvents = []) {
        const all = [...DB.data.personalEvents, ...DB.data.schoolEvents, ...extraEvents];
        const nS = this.toMin(newE.time);
        const nE = nS + (newE.duration*60);
        for(let e of all) {
            if(e.date === newE.date && e.id !== newE.id && e.time) {
                const eS = this.toMin(e.time);
                if(nS < eS + (e.duration*60) && nE > eS) return { conflict: true, event: e };
            }
        }
        return { conflict: false };
    },

    handleAddEvent() {
        const newE = {
            id: Date.now(),
            title: document.getElementById('addTitle').value,
            date: document.getElementById('addDate').value,
            time: document.getElementById('addTime').value,
            duration: parseFloat(document.getElementById('addDuration').value),
            type: document.getElementById('addType').value,
            isAuto: false,
            difficulty: document.getElementById('addDifficulty').value
        };
        if(!newE.title || !newE.date || !newE.time) return alert('×—×¡×¨ ××™×“×¢');
        
        const conf = this.checkConflict(newE);
        if(conf.conflict) {
            document.getElementById('conflictMsg').innerText = `××ª× ×’×© ×¢× ${conf.event.title}`;
            document.getElementById('conflictError').style.display = 'block';
            return;
        }

        // If Exam -> Trigger AI
        if (newE.type === 'exam') {
            ui.closeModals(); // Close add modal
            this.ai.preparePlan(newE); // Open AI modal
            return;
        }
        
        DB.data.personalEvents.push(newE);
        DB.save();
        ui.closeModals();
        app.render();
    },

    /** AI PLANNER MODULE */
    ai: {
        tempExam: null,
        tempBlocks: [],
        
        preparePlan(examEvent, randomize = false) {
            this.tempExam = examEvent;
            const plan = this.generatePlan(examEvent, randomize);
            this.tempBlocks = plan.blocks;
            
            // Show UI
            document.getElementById('aiMessage').innerHTML = plan.message;
            const list = document.getElementById('aiBlocksList');
            list.innerHTML = '';
            plan.blocks.forEach(b => {
                list.innerHTML += `<div class="ai-proposal-item">ğŸ“… ${logic.formatDateIL(b.date)} â° ${b.time} (${b.duration}×©')</div>`;
            });
            document.getElementById('aiModal').classList.add('active');
        },

        generatePlan(exam, randomize) {
            const hoursNeeded = parseInt(exam.difficulty) || 4;
            let currentNeeded = hoursNeeded;
            const blocks = [];
            const daysBack = 7;
            const candidates = [];

            // 1. Scan days backward
            for (let i = 1; i <= daysBack; i++) {
                const d = logic.addDays(exam.date, -i);
                if (new Date(d) < new Date().setHours(0,0,0,0)) continue;
                
                // Scan times 16:00 - 21:00
                for (let t = 16*60; t <= 21*60; t+=30) {
                    const timeStr = logic.toTimeStr(t);
                    const dur = 1.5; // Study block duration
                    
                    // Check Conflict
                    const tempBlock = { id: -1, date: d.toISOString().split('T')[0], time: timeStr, duration: dur };
                    const conf = logic.checkConflict(tempBlock, blocks); // Check against DB + already planned blocks
                    
                    if (!conf.conflict) {
                        let score = 100 - (i * 5); // Earlier is better
                        if (t >= 17*60 && t <= 19*60) score += 20; // Preferred hours
                        if (randomize) score += Math.random() * 50; // Randomize for "Try Again"
                        
                        candidates.push({ ...tempBlock, score });
                    }
                }
            }

            // 2. Sort & Pick
            candidates.sort((a,b) => b.score - a.score);
            
            // Pick non-overlapping from candidates
            for (let cand of candidates) {
                if (currentNeeded <= 0) break;
                // Check internal overlap with selected blocks
                const overlap = blocks.some(b => b.date === cand.date && 
                    ((logic.toMin(b.time) < logic.toMin(cand.time)+90) && (logic.toMin(b.time)+90 > logic.toMin(cand.time))));
                
                if (!overlap) {
                    blocks.push(cand);
                    currentNeeded -= 1.5;
                }
            }

            // 3. Message
            const dayNames = [...new Set(blocks.map(b => logic.getDayName(b.date)))];
            const msg = blocks.length > 0 
                ? `×™×© ×œ×š ××‘×—×Ÿ ×‘-${logic.getDayName(exam.date)}. ××¦××ª×™ ${blocks.length} ×—×œ×•× ×•×ª ×œ××™×“×” ×‘×™××™×: <b>${dayNames.join(', ')}</b>.`
                : `×œ× ××¦××ª×™ ××¡×¤×™×§ ×–××Ÿ ×¤× ×•×™ ×”×©×‘×•×¢. × ×¡×” ×œ×¤× ×•×ª ×–××Ÿ ×‘×™×•××Ÿ.`;

            return { blocks, message: msg };
        },

        confirmPlan() {
            // Save Exam
            // Check if exam exists (update) or new
            const existingIdx = DB.data.personalEvents.findIndex(e => e.id === this.tempExam.id);
            if (existingIdx > -1) DB.data.personalEvents[existingIdx] = this.tempExam;
            else DB.data.personalEvents.push(this.tempExam);

            // Save Blocks
            const finalBlocks = this.tempBlocks.map(b => ({
                id: Date.now() + Math.random(),
                title: `×œ××™×“×” ×œ${this.tempExam.title}`,
                type: 'study',
                date: b.date,
                time: b.time,
                duration: b.duration,
                isAuto: true,
                linkedExamId: this.tempExam.id
            }));
            
            DB.data.personalEvents.push(...finalBlocks);
            DB.save();
            document.getElementById('aiModal').classList.remove('active');
            app.render();
            alert('âœ… ×”××‘×—×Ÿ ×•×ª×•×›× ×™×ª ×”×œ××™×“×” × ×©××¨×• ×‘×”×¦×œ×—×”!');
        },

        retryPlan() {
            this.preparePlan(this.tempExam, true);
        },

        cancelPlan() {
            // Save only exam
            const existingIdx = DB.data.personalEvents.findIndex(e => e.id === this.tempExam.id);
            if (existingIdx > -1) DB.data.personalEvents[existingIdx] = this.tempExam;
            else DB.data.personalEvents.push(this.tempExam);
            
            DB.save();
            document.getElementById('aiModal').classList.remove('active');
            app.render();
        },
        
        planFromView() {
             // Fetch current view event
             const title = document.getElementById('viewTitle').innerText;
             const evt = DB.data.personalEvents.find(e => e.title === title && e.type === 'exam');
             if(evt) {
                 ui.closeModals();
                 this.preparePlan(evt);
             }
        },

        deletePlanFromView() {
            const title = document.getElementById('viewTitle').innerText;
             const evt = DB.data.personalEvents.find(e => e.title === title && e.type === 'exam');
             if(evt && confirm('×œ××—×•×§ ××ª ×›×œ ×‘×œ×•×§×™ ×”×œ××™×“×” ×©×œ ×”××‘×—×Ÿ ×”×–×”?')) {
                 DB.data.personalEvents = DB.data.personalEvents.filter(e => e.linkedExamId !== evt.id);
                 DB.save();
                 ui.closeModals();
                 app.render();
             }
        }
    }
};

/** UI */
const ui = {
    openAddModal() {
        document.getElementById('addModal').classList.add('active');
        document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('conflictError').style.display = 'none';
    },
    closeModals() { document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.remove('active')); },
    toggleExamFields() { document.getElementById('examFields').style.display = document.getElementById('addType').value==='exam'?'block':'none'; },
    
    openViewModal(e, isSchool) {
        document.getElementById('viewModal').classList.add('active');
        document.getElementById('viewTitle').innerText = e.title;
        document.getElementById('viewDate').innerText = logic.formatDateIL(e.date);
        document.getElementById('viewTime').innerText = e.time || '×™×•× ×©×œ×';
        document.getElementById('viewDuration').innerText = e.duration + ' ×©×¢×•×ª';
        document.getElementById('viewType').innerHTML = `<span class="tag ${isSchool?'school':e.type}">${e.type}</span>`;
        
        const btn = document.getElementById('btnDelete');
        const aiActions = document.getElementById('aiActions');
        const aiDel = document.getElementById('aiDeleteActions');
        
        // Reset
        aiActions.style.display = 'none';
        aiDel.style.display = 'none';

        if(isSchool) {
            btn.style.display = 'none';
        } else {
            btn.style.display = 'block'; 
            btn.onclick=()=>{ if(confirm('×œ××—×•×§?')) DB.deleteEvent(e.id); };
            
            // AI Planner Buttons for Exams
            if(e.type === 'exam') {
                const hasBlocks = DB.data.personalEvents.some(b => b.linkedExamId === e.id);
                if(!hasBlocks) aiActions.style.display = 'block';
                else aiDel.style.display = 'block';
            }
        }
    },
    
    getEvtColor(t) {
        if(t.includes('exam')||t.includes('××‘×—×Ÿ')) return 'ct-exam';
        if(t.includes('activity')||t.includes('×¤×¢×™×œ×•×ª')) return 'ct-activity';
        if(t.includes('study')||t.includes('×œ××™×“×”')) return 'ct-study';
        return 'ct-school';
    },

    getStartOfWeek(d) {
        const date = new Date(d);
        const day = date.getDay(); 
        const diff = date.getDate() - day;
        return new Date(date.setDate(diff));
    }
};

/** RENDERER */
const app = {
    currentPage: 'dashboard',
    
    navigate(p) {
        this.currentPage = p;
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        const idx = p==='dashboard'?0 : p==='calendar'?1 : 2;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        document.querySelectorAll('.sidebar .nav-item')[idx].classList.add('active');
        this.render();
    },

    render() {
        const con = document.getElementById('viewContainer');
        con.innerHTML = '';
        if(this.currentPage === 'dashboard') this.renderDashboard(con);
        else if(this.currentPage === 'calendar') this.renderGenericCalendar(con, 'personal');
        else this.renderSchool(con);
    },

    renderDashboard(con) {
        const today = new Date().toISOString().split('T')[0];
        const evts = DB.data.personalEvents.filter(e=>e.date>=today).sort((a,b)=>a.date.localeCompare(b.date));
        let html = `<h1>×“××©×‘×•×¨×“ âš¡</h1>`;
        if(evts.length) html += `<div class="card" style="border-right:4px solid var(--primary)"><h3>${evts[0].title}</h3><p>${logic.formatDateIL(evts[0].date)} | ${evts[0].time}</p></div>`;
        else html += `<div class="card">××™×Ÿ ××™×¨×•×¢×™× ×§×¨×•×‘×™×.</div>`;
        con.innerHTML = html;
    },

    renderGenericCalendar(con, mode) {
        const isSchool = mode === 'school';
        const events = isSchool ? DB.data.schoolEvents : [...DB.data.personalEvents, ...DB.data.schoolEvents];
        const anchor = new Date(isSchool ? DB.data.schoolAnchor : DB.data.calendarAnchor);
        const view = isSchool ? DB.data.schoolView : DB.data.calendarView;

        let titleRange = '';
        if (view === 'day') titleRange = `${logic.formatDateIL(anchor.toISOString().split('T')[0])}`;
        else if (view === 'week') {
            const start = ui.getStartOfWeek(anchor);
            const end = logic.addDays(start, 6);
            titleRange = `${logic.formatDateIL(end.toISOString().split('T')[0])} - ${logic.formatDateIL(start.toISOString().split('T')[0])}`;
        }
        else if (view === 'month') titleRange = anchor.toLocaleDateString('he-IL', { month:'long', year:'numeric' });
        else if (view === 'year') titleRange = anchor.getFullYear();

        let html = isSchool ? `<h2>×œ×•×— ×‘×™×ª ×¡×¤×¨ ğŸ«</h2>` : `<h2>×”×™×•××Ÿ ×©×œ×™</h2>`;

        html += `
        <div class="cal-controls">
            <div class="cal-top-row">
                <button class="btn-today" onclick="logic.jumpToToday('${mode}')">×”×™×•×</button>
                <div class="cal-nav-group">
                    <button class="btn-icon" onclick="logic.navCalendar(-1, '${mode}')">â®</button>
                    <div class="cal-title">${titleRange}</div>
                    <button class="btn-icon" onclick="logic.navCalendar(1, '${mode}')">â¯</button>
                </div>
            </div>
            <div class="view-switcher">
                <div class="view-btn ${view==='day'?'active':''}" onclick="logic.setView('day', '${mode}')">×™×•×</div>
                <div class="view-btn ${view==='week'?'active':''}" onclick="logic.setView('week', '${mode}')">×©×‘×•×¢</div>
                <div class="view-btn ${view==='month'?'active':''}" onclick="logic.setView('month', '${mode}')">×—×•×“×©</div>
                <div class="view-btn ${view==='year'?'active':''}" onclick="logic.setView('year', '${mode}')">×©× ×”</div>
            </div>
        </div>`;

        if (view === 'day') {
            const dStr = anchor.toISOString().split('T')[0];
            const dayEvts = events.filter(e => e.date === dStr).sort((a,b) => a.time.localeCompare(b.time));
            html += `<div class="day-view-list">`;
            if(dayEvts.length === 0) html += `<div class="card" style="text-align:center; color:#999">××™×Ÿ ××™×¨×•×¢×™× ×œ×™×•× ×–×”</div>`;
            dayEvts.forEach(e => {
                const eJson = JSON.stringify(e).replace(/'/g, "&#39;");
                html += `
                <div class="day-time-slot" onclick='ui.openViewModal(${eJson}, ${e.source==='google_sheets'})'>
                    <div class="dt-time">${e.time || '--'}</div>
                    <div style="flex:1">
                        <div style="font-weight:bold">${e.title}</div>
                        <div class="cal-tag ${ui.getEvtColor(e.type)}" style="display:inline-block">${e.type}</div>
                    </div>
                </div>`;
            });
            html += `</div>`;

        } else if (view === 'week') {
            const start = ui.getStartOfWeek(anchor);
            html += `<div class="week-grid-container"><div class="week-grid">`;
            for(let i=0; i<7; i++) {
                const curr = logic.addDays(start, i);
                const dStr = curr.toISOString().split('T')[0];
                const dayEvts = events.filter(e => e.date === dStr).sort((a,b)=>a.time.localeCompare(b.time));
                html += `<div class="week-col">
                    <div class="week-header">${logic.getDayName(dStr)} ${logic.formatDateIL(dStr)}</div>
                    <div class="week-body">`;
                dayEvts.forEach(e => {
                    const eJson = JSON.stringify(e).replace(/'/g, "&#39;");
                    html += `<div class="cal-tag ${ui.getEvtColor(e.type)}" onclick='ui.openViewModal(${eJson}, ${e.source==='google_sheets'})'>
                        ${e.time} ${e.title}
                    </div>`;
                });
                html += `</div></div>`;
            }
            html += `</div></div>`;

        } else if (view === 'month') {
            const y = anchor.getFullYear(), m = anchor.getMonth();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const startPadding = new Date(y, m, 1).getDay();
            
            html += `<div class="month-grid">
                <div class="month-header-cell">×'</div><div class="month-header-cell">×‘'</div>
                <div class="month-header-cell">×’'</div><div class="month-header-cell">×“'</div>
                <div class="month-header-cell">×”'</div><div class="month-header-cell">×•'</div>
                <div class="month-header-cell">×©'</div>`;
            for(let i=0; i<startPadding; i++) html += `<div class="month-day other-month"></div>`;
            
            const todayStr = new Date().toISOString().split('T')[0];
            for(let d=1; d<=daysInMonth; d++) {
                const currStr = new Date(y, m, d+1).toISOString().split('T')[0];
                const isToday = currStr === todayStr;
                const dayEvts = events.filter(e => e.date === currStr);
                
                html += `<div class="month-day ${isToday?'today':''}" onclick="DB.data.${isSchool?'schoolAnchor':'calendarAnchor'}=${new Date(y,m,d).getTime()};logic.setView('day', '${mode}')">
                    <div class="month-day-num">${d}</div>`;
                dayEvts.slice(0,3).forEach(e => {
                    html += `<div class="cal-tag ${ui.getEvtColor(e.type)}" style="height:6px; margin-bottom:2px; padding:0;"></div>`;
                });
                if(dayEvts.length > 3) html += `<div style="font-size:0.6rem; color:#999">+${dayEvts.length-3}</div>`;
                html += `</div>`;
            }
            html += `</div>`;

        } else if (view === 'year') {
            const months = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
            html += `<div class="year-grid">`;
            months.forEach((name, idx) => {
                html += `<div class="year-month" onclick="logic.jumpToMonth(${idx}, ${anchor.getFullYear()}, '${mode}')">${name}</div>`;
            });
            html += `</div>`;
        }

        if(isSchool) {
            let opts = `<option value="">-- ×‘×—×¨ ×œ×•×— --</option>`;
            for(let k in SCHOOL_SHEETS) opts += `<option value="${k}" ${DB.data.selectedSheetKey===k?'selected':''}>${k}</option>`;
            const lastSync = DB.data.lastSync ? new Date(DB.data.lastSync).toLocaleTimeString() : '...';
            const syncHtml = `<div class="sync-box"><div class="input-group-row">
                <select onchange="logic.handleSheetSelection(this.value)">${opts}</select>
                <button class="btn btn-primary" onclick="logic.syncFromSheets(DB.data.schoolSheetUrl)">×¨×¢× ×Ÿ</button>
            </div><div style="font-size:0.8rem;margin-top:5px;opacity:0.7">×¢×•×“×›×Ÿ: ${lastSync}</div></div>`;
            con.innerHTML = syncHtml + html;
        } else {
            con.innerHTML = html;
        }
    },

    renderSchool(con) {
        this.renderGenericCalendar(con, 'school');
    }
};

DB.init();
app.navigate('school');
</script>
</body>
</html>