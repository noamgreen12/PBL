<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent Pro v3.0</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #eef2ff;
            --secondary: #3f37c9;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #212529;
            --text-muted: #6c757d;
            --safe: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e71d36;
            --school: #7209b7;
            --school-light: #f3e5f5;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; tap-highlight-color: transparent; }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Layout --- */
        .app-container { display: flex; height: 100%; width: 100%; }
        
        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px; background: var(--card-bg); padding: 25px;
            display: none; flex-direction: column; gap: 10px;
            border-left: 1px solid rgba(0,0,0,0.05); z-index: 10;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
        
        /* Bottom Nav (Mobile) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: var(--card-bg); display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100;
            border-radius: 20px 20px 0 0;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 12px;
            transition: 0.2s; font-size: 0.8rem; font-weight: 500;
        }
        .nav-item.active { color: var(--primary); background: var(--primary-light); }
        .nav-item i { font-size: 1.4rem; font-style: normal; }
        
        /* Desktop Sidebar Items */
        .sidebar .nav-item { flex-direction: row; justify-content: flex-start; font-size: 1rem; padding: 12px; }

        /* --- Main Content --- */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; max-width: 1000px; margin: 0 auto; width: 100%; }

        /* --- Typography & Components --- */
        h1, h2, h3 { margin: 0; }
        h2 { font-size: 1.25rem; margin-bottom: 15px; color: var(--text); display: flex; align-items: center; justify-content: space-between; }
        
        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 16px;
            margin-bottom: 16px; box-shadow: var(--shadow); position: relative;
            border: 1px solid rgba(0,0,0,0.02); transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        /* Event Item Styles */
        .event-row {
            display: flex; align-items: flex-start; gap: 12px; padding: 12px 0;
            border-bottom: 1px solid #f1f3f5; cursor: pointer;
        }
        .event-row:last-child { border-bottom: none; }
        
        .date-badge {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 50px; background: #f8f9fa; border-radius: 10px; padding: 6px;
            font-weight: bold; font-size: 0.8rem; color: var(--text-muted);
        }
        .date-badge.today { background: var(--primary-light); color: var(--primary); }
        
        .event-info { flex: 1; }
        .event-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
        .event-meta { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); flex-wrap: wrap; }
        
        .tag { padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        .tag.exam { background: #ffe3e3; color: var(--danger); }
        .tag.study { background: #e3f2fd; color: #1976d2; }
        .tag.school { background: var(--school-light); color: var(--school); }
        .tag.auto { background: linear-gradient(135deg, #4361ee, #3f37c9); color: white; }

        /* AI Insight Box */
        .ai-box {
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            border-right: 4px solid var(--primary); padding: 16px; margin-bottom: 20px;
        }

        /* --- School Board Specific --- */
        .school-header { background: var(--school); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 200; backdrop-filter: blur(4px);
            display: none; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 100%; max-width: 500px;
            border-radius: 24px 24px 0 0; padding: 24px;
            max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* FAB */
        .fab {
            position: fixed; bottom: 90px; left: 20px; width: 56px; height: 56px;
            background: var(--text); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 28px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); cursor: pointer; z-index: 150;
        }

        /* Forms & Buttons */
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 16px; font-family: var(--font); }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); margin-top: 20px; }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (min-width: 768px) {
            .sidebar { display: flex; } .bottom-nav { display: none; }
            .fab { left: 50%; margin-left: -400px; bottom: 40px; } /* Position relative to content */
            .modal-overlay { align-items: center; } .modal-content { border-radius: 24px; padding: 40px; }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo">SmartStudent Pro</div>
        <div class="nav-item active" onclick="app.navigate('dashboard')"><i>âš¡</i> ×“××©×‘×•×¨×“</div>
        <div class="nav-item" onclick="app.navigate('calendar')"><i>ğŸ“…</i> ×”×™×•××Ÿ ×©×œ×™</div>
        <div class="nav-item" onclick="app.navigate('school')"><i>ğŸ«</i> ×œ×•×— ×‘×™×ª ×¡×¤×¨</div>
    </aside>

    <main class="main-content" id="viewContainer">
        </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="app.navigate('dashboard')"><i>âš¡</i><span>×“××©×‘×•×¨×“</span></div>
        <div class="nav-item" onclick="app.navigate('calendar')"><i>ğŸ“…</i><span>×™×•××Ÿ</span></div>
        <div class="nav-item" onclick="app.navigate('school')"><i>ğŸ«</i><span>×‘×™×”"×¡</span></div>
    </nav>
</div>

<div class="fab" onclick="ui.openAddModal()">+</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <h2>×”×•×¡×¤×ª ××™×¨×•×¢ ×—×“×©</h2>
        <form onsubmit="return false;">
            <label>×›×•×ª×¨×ª</label>
            <input type="text" id="addTitle" placeholder="××‘×—×Ÿ ×‘×”×™×¡×˜×•×¨×™×” / ×—×•×’...">
            
            <label>×¡×•×’</label>
            <select id="addType" onchange="ui.toggleExamFields()">
                <option value="activity">×¤×¢×™×œ×•×ª / ×—×•×’</option>
                <option value="assignment">××˜×œ×” ×œ×”×’×©×”</option>
                <option value="exam">××‘×—×Ÿ (×”×¤×¢×œ×ª AI Planner)</option>
            </select>

            <div id="examFields" class="hidden" style="background: #f0f4ff; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <label>×¨××ª ×§×•×©×™ (×œ×—×™×©×•×‘ ×©×¢×•×ª ×”×›× ×”)</label>
                <select id="addDifficulty">
                    <option value="2">×§×œ (2 ×©×¢×•×ª)</option>
                    <option value="4" selected>×‘×™× ×•× ×™ (4 ×©×¢×•×ª)</option>
                    <option value="7">×§×©×” (7 ×©×¢×•×ª)</option>
                </select>
                <small style="color:var(--primary)">×”-AI ×™×™×¦×•×¨ ×¢×‘×•×¨×š ×ª×•×›× ×™×ª ×œ×™××•×“ ××•×˜×•××˜×™×ª</small>
            </div>

            <label>×ª××¨×™×š</label>
            <input type="date" id="addDate" required>
            
            <label>×©×¢×”</label>
            <input type="time" id="addTime" value="16:00">
            
            <label>××©×š (×‘×©×¢×•×ª)</label>
            <input type="number" id="addDuration" value="1" step="0.5">

            <button class="btn btn-primary" onclick="logic.handleAddEvent()">×©××•×¨ ××™×¨×•×¢</button>
            <button class="btn btn-ghost" onclick="ui.closeModals()">×‘×™×˜×•×œ</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="viewModal">
    <div class="modal-content">
        <h2 id="viewTitle">×›×•×ª×¨×ª</h2>
        <div style="margin-bottom: 20px; color: var(--text-muted); line-height: 1.6;">
            <div>ğŸ“… <span id="viewDate"></span></div>
            <div>â° <span id="viewTime"></span></div>
            <div>â³ <span id="viewDuration"></span></div>
            <div id="viewType" style="margin-top:10px;"></div>
        </div>
        
        <p id="viewDesc" style="background:#f8f9fa; padding:10px; border-radius:8px; display:none;"></p>

        <button class="btn btn-primary" onclick="ui.closeModals()">×¡×’×•×¨</button>
        <button id="btnDelete" class="btn btn-danger" onclick="">ğŸ—‘ï¸ ××—×§ ××™×¨×•×¢</button>
    </div>
</div>

<script>
/**
 * --- DATA LAYER ---
 */
const DB = {
    key: 'smartStudentV3',
    data: {
        personalEvents: [],
        schoolEvents: []
    },
    
    init() {
        const stored = localStorage.getItem(this.key);
        if (stored) {
            this.data = JSON.parse(stored);
            // Ensure structure integrity for upgrades
            if (!this.data.schoolEvents) this.data.schoolEvents = [];
        } else {
            this.seed();
        }
    },
    
    save() {
        localStorage.setItem(this.key, JSON.stringify(this.data));
        app.render();
    },

    seed() {
        const today = new Date().toISOString().split('T')[0];
        // Add sample school events
        this.data.schoolEvents = [
            { id: 's1', title: '×˜×™×•×œ ×©× ×ª×™ ×©×›×‘×” ×™×³', date: logic.addDays(today, 5), type: 'school', audience: '×©×›×‘×” ×™×³' },
            { id: 's2', title: '×—×œ×•×§×ª ×ª×¢×•×“×•×ª', date: logic.addDays(today, 14), type: 'school', audience: '×›×œ ×‘×™×”×´×¡' },
            { id: 's3', title: '××ª×›×•× ×ª ×‘×œ×©×•×Ÿ', date: logic.addDays(today, 2), type: 'school', audience: '×™×‘×³' }
        ];
        // Add sample personal events
        this.data.personalEvents = [
            { id: 101, title: '×—×•×’ ×’×™×˜×¨×”', type: 'activity', date: today, time: '17:00', duration: 1, isAuto: false },
            { id: 102, title: '××‘×—×Ÿ ×‘××ª××˜×™×§×”', type: 'exam', date: logic.addDays(today, 3), time: '09:00', duration: 2, isAuto: false }
        ];
        this.save();
    },

    deleteEvent(id) {
        // 1. Check if it's an exam to delete linked study blocks
        const isExam = this.data.personalEvents.find(e => e.id == id && e.type === 'exam');
        
        if (isExam) {
            // Delete all linked study blocks
            const initialCount = this.data.personalEvents.length;
            this.data.personalEvents = this.data.personalEvents.filter(e => e.linkedExamId != id);
            console.log(`Deleted ${initialCount - this.data.personalEvents.length} linked study blocks.`);
        }

        // 2. Delete the event itself
        this.data.personalEvents = this.data.personalEvents.filter(e => e.id != id);
        this.save();
    }
};

/**
 * --- LOGIC & HELPERS ---
 */
const logic = {
    addDays(dateStr, days) {
        const d = new Date(dateStr);
        d.setDate(d.getDate() + days);
        return d.toISOString().split('T')[0];
    },

    getRelativeTime(dateStr) {
        const target = new Date(dateStr).setHours(0,0,0,0);
        const today = new Date().setHours(0,0,0,0);
        const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        
        if (diff < 0) return '×¢×‘×¨';
        if (diff === 0) return '×”×™×•×';
        if (diff === 1) return '××—×¨';
        if (diff === 2) return '××—×¨×ª×™×™×';
        return `×‘×¢×•×“ ${diff} ×™××™×`;
    },

    getDayName(dateStr) {
        const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
        return days[new Date(dateStr).getDay()];
    },
    
    formatDateIL(dateStr) {
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}`;
    },

    // Simple AI Planner (Heuristic)
    runAIPlanner(examEvent) {
        const daysBack = 4;
        let createdBlocks = 0;
        
        // Try to find slots in previous days
        for(let i=1; i<=daysBack; i++) {
            const checkDate = this.addDays(examEvent.date, -i);
            // Basic heuristic: Is date in future?
            if (new Date(checkDate) < new Date()) continue;
            
            // Check load (fake heuristic for demo)
            const dailyEvents = DB.data.personalEvents.filter(e => e.date === checkDate).length;
            
            if (dailyEvents < 2) {
                // Add study block
                DB.data.personalEvents.push({
                    id: Date.now() + Math.random(),
                    title: `×œ××™×“×” ×œ${examEvent.title}`,
                    type: 'study',
                    date: checkDate,
                    time: '16:00',
                    duration: 1.5,
                    isAuto: true,
                    linkedExamId: examEvent.id
                });
                createdBlocks++;
                if (createdBlocks >= 2) break; // Limit to 2 blocks
            }
        }
        return createdBlocks;
    },

    handleAddEvent() {
        const title = document.getElementById('addTitle').value;
        const date = document.getElementById('addDate').value;
        const type = document.getElementById('addType').value;
        
        if(!title || !date) { alert('×—×¡×¨×™× ×¤×¨×˜×™×!'); return; }

        const newEvent = {
            id: Date.now(),
            title: title,
            type: type,
            date: date,
            time: document.getElementById('addTime').value,
            duration: parseFloat(document.getElementById('addDuration').value),
            isAuto: false
        };

        DB.data.personalEvents.push(newEvent);

        // If Exam -> Trigger AI
        if (type === 'exam') {
            const blocks = this.runAIPlanner(newEvent);
            if(blocks > 0) alert(`ğŸ¤– ×”-AI ×™×¦×¨ ×¢×‘×•×¨×š ${blocks} ×‘×œ×•×§×™ ×œ××™×“×” ×‘×™×•××Ÿ!`);
        }

        DB.save();
        ui.closeModals();
    }
};

/**
 * --- UI CONTROLLER ---
 */
const ui = {
    toggleExamFields() {
        const type = document.getElementById('addType').value;
        const fields = document.getElementById('examFields');
        type === 'exam' ? fields.classList.remove('hidden') : fields.classList.add('hidden');
    },

    openAddModal() {
        document.getElementById('addModal').classList.add('active');
        document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
    },

    openViewModal(eventObj, isSchool) {
        document.getElementById('viewModal').classList.add('active');
        document.getElementById('viewTitle').innerText = eventObj.title;
        document.getElementById('viewDate').innerText = `${logic.getDayName(eventObj.date)}, ${logic.formatDateIL(eventObj.date)} (${logic.getRelativeTime(eventObj.date)})`;
        document.getElementById('viewTime').innerText = eventObj.time || '×›×œ ×”×™×•×';
        document.getElementById('viewDuration').innerText = eventObj.duration ? `${eventObj.duration} ×©×¢×•×ª` : '-';
        
        const typeEl = document.getElementById('viewType');
        
        if (isSchool) {
            typeEl.innerHTML = '<span class="tag school">××™×¨×•×¢ ×‘×™×ª ×¡×¤×¨</span>';
            document.getElementById('btnDelete').style.display = 'none'; // Cannot delete school events
            document.getElementById('viewDesc').style.display = 'block';
            document.getElementById('viewDesc').innerText = `×§×”×œ ×™×¢×“: ${eventObj.audience}`;
        } else {
            typeEl.innerHTML = `<span class="tag ${eventObj.type}">${eventObj.type}</span>`;
            document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('btnDelete').onclick = () => {
                if(confirm('×œ××—×•×§ ××ª ×”××™×¨×•×¢? (×× ×–×” ××‘×—×Ÿ, ×™×™××—×§×• ×’× ×–×× ×™ ×”×œ××™×“×”)')) {
                    DB.deleteEvent(eventObj.id);
                    ui.closeModals();
                }
            };
            document.getElementById('viewDesc').style.display = 'none';
        }
    },

    closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        document.querySelector('form').reset();
    }
};

/**
 * --- APP ROUTING & RENDERING ---
 */
const app = {
    currentPage: 'dashboard',

    navigate(page) {
        this.currentPage = page;
        // Update Nav Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Simple logic to find active nav items (based on order or manual check - keeping it simple)
        // Re-rendering handles content
        this.render();
    },

    render() {
        const container = document.getElementById('viewContainer');
        container.innerHTML = '';
        
        switch(this.currentPage) {
            case 'dashboard': this.renderDashboard(container); break;
            case 'calendar': this.renderCalendar(container); break;
            case 'school': this.renderSchoolBoard(container); break;
        }
    },

    renderDashboard(container) {
        const today = new Date().toISOString().split('T')[0];
        
        // Filter Events
        const upcoming = DB.data.personalEvents
            .filter(e => e.date >= today)
            .sort((a,b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
        
        const nextExam = upcoming.find(e => e.type === 'exam');
        const todaysEvents = upcoming.filter(e => e.date === today);

        // --- HTML GEN ---
        let html = `<h1>×‘×•×§×¨ ×˜×•×‘ ğŸ‘‹</h1>`;
        
        // 1. AI Insight
        html += `<div class="card ai-box">
            <strong>ğŸ¤– ×”×ª×•×‘× ×” ×”×™×•××™×ª (${logic.formatDateIL(today)}):</strong><br>
            ${todaysEvents.length > 3 
                ? '×”×™×•× ×©×œ×š ×¢××•×¡ ×××•×“! × ×¡×” ×œ×”×ª××§×“ ×¨×§ ×‘×“×‘×¨×™× ×”×—×©×•×‘×™×.' 
                : '×”×™×•× × ×¨××” ×¨×’×•×¢ ×™×—×¡×™×ª. ×–××Ÿ ×˜×•×‘ ×œ×”×©×œ×™× ×¤×¢×¨×™×.'}
        </div>`;

        // 2. Next Exam
        if (nextExam) {
            html += `
            <div class="card" style="border-right: 4px solid var(--danger);">
                <div style="font-size:0.8rem; color:var(--danger); font-weight:bold; margin-bottom:5px;">××‘×—×Ÿ ×§×¨×•×‘</div>
                <div style="font-size:1.2rem; font-weight:bold;">${nextExam.title}</div>
                <div style="margin-top:5px; color:var(--text-muted);">
                    ğŸ“… ${logic.getDayName(nextExam.date)} ${logic.formatDateIL(nextExam.date)} 
                    <span style="background: #ffe3e3; color: #c0392b; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${logic.getRelativeTime(nextExam.date)}</span>
                </div>
            </div>`;
        }

        // 3. Upcoming List
        html += `<h3>×”××™×¨×•×¢×™× ×”×‘××™×</h3>`;
        if (upcoming.length === 0) {
            html += `<p style="color:var(--text-muted); margin-top:10px;">××™×Ÿ ××™×¨×•×¢×™× ×§×¨×•×‘×™×. ××™×–×” ×›×™×£!</p>`;
        } else {
            html += `<div class="card">`;
            upcoming.slice(0, 5).forEach(e => {
                html += this.buildEventRow(e, false);
            });
            html += `</div>`;
        }
        
        container.innerHTML = html;
    },

    renderCalendar(container) {
        // Merge Personal + School for display
        const allEvents = [
            ...DB.data.personalEvents.map(e => ({...e, source: 'personal'})),
            ...DB.data.schoolEvents.map(e => ({...e, source: 'school', time: '08:00'})) // School events usually morning
        ];
        
        // Group by Date
        const grouped = {};
        allEvents.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(e => {
            if(!grouped[e.date]) grouped[e.date] = [];
            grouped[e.date].push(e);
        });

        let html = `<h2>×”×™×•××Ÿ ×”××œ×</h2>`;
        const dates = Object.keys(grouped).sort();

        if (dates.length === 0) html += `<p>×”×™×•××Ÿ ×¨×™×§.</p>`;

        dates.forEach(date => {
            const isToday = date === new Date().toISOString().split('T')[0];
            html += `<h3 style="margin-top:20px; font-size:1rem; color:${isToday ? 'var(--primary)' : '#666'}">
                ${logic.getDayName(date)} ${logic.formatDateIL(date)} ${isToday ? '(×”×™×•×)' : ''}
            </h3>`;
            html += `<div class="card">`;
            grouped[date].sort((a,b) => a.time.localeCompare(b.time)).forEach(e => {
                html += this.buildEventRow(e, e.source === 'school');
            });
            html += `</div>`;
        });
        
        container.innerHTML = html;
    },

    renderSchoolBoard(container) {
        const events = DB.data.schoolEvents.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let html = `
            <div class="school-header">
                <h2>ğŸ« ×œ×•×— ××™×¨×•×¢×™ ×‘×™×ª ×¡×¤×¨</h2>
                <p style="margin:0; opacity:0.9">×œ×•×— ×–×” ×× ×•×”×œ ×¢"×™ ×‘×™×”"×¡ ×•×œ× × ×™×ª×Ÿ ×œ×¢×¨×™×›×”.</p>
            </div>
        `;

        if (events.length === 0) {
            html += `<div class="card">××™×Ÿ ×”×•×“×¢×•×ª ×—×“×©×•×ª ××‘×™×ª ×”×¡×¤×¨.</div>`;
        } else {
            events.forEach(e => {
                html += `
                <div class="card" onclick="ui.openViewModal({title:'${e.title}', date:'${e.date}', time:'${e.audience}', duration: '', audience: '${e.audience}'}, true)">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div class="event-title">${e.title}</div>
                            <div class="event-meta">
                                <span>ğŸ“… ${logic.getDayName(e.date)} ${logic.formatDateIL(e.date)}</span>
                                <span class="tag school">${e.audience}</span>
                            </div>
                        </div>
                        <span style="font-size:0.8rem; background:#f3e5f5; color:#7209b7; padding:4px 8px; border-radius:6px;">
                            ${logic.getRelativeTime(e.date)}
                        </span>
                    </div>
                </div>`;
            });
        }
        container.innerHTML = html;
    },

    buildEventRow(e, isSchool) {
        // Helper to generate the HTML for a single event row
        const timeDisplay = e.time || '×™×•× ××œ×';
        const tagClass = isSchool ? 'school' : e.type;
        const tagName = isSchool ? '×‘×™×”"×¡' : (e.type === 'exam' ? '××‘×—×Ÿ' : (e.type === 'study' ? '×œ××™×“×”' : '××—×¨'));
        
        // Pass the object safely to onclick by storing ID and lookup or passing primitives. 
        // For simplicity in this single file, we'll recreate the object in the onclick handler or fetch by ID.
        // Best approach here: fetch by ID.
        
        // Hack for passing object to modal without complexity:
        const safeTitle = e.title.replace(/'/g, "\\'"); 
        
        // Using a data attribute approach would be cleaner, but inline for single file speed:
        return `
            <div class="event-row" onclick='ui.openViewModal(${JSON.stringify(e)}, ${isSchool})'>
                <div class="date-badge ${logic.getRelativeTime(e.date) === '×”×™×•×' ? 'today' : ''}">
                    <span>${logic.formatDateIL(e.date)}</span>
                    <span style="font-weight:400; font-size:0.7rem">${e.time}</span>
                </div>
                <div class="event-info">
                    <div class="event-title">${e.title}</div>
                    <div class="event-meta">
                        <span class="tag ${tagClass}">${tagName}</span>
                        ${e.isAuto ? '<span class="tag auto">AI</span>' : ''}
                        <span>${logic.getRelativeTime(e.date)}</span>
                    </div>
                </div>
            </div>
        `;
    }
};

// Start App
DB.init();
app.render();

</script>
</body>
</html>