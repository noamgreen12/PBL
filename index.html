<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent - × ×™×”×•×œ ×–××Ÿ ×•×¢× ×Ÿ</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #eef2ff;
            --secondary: #10b981;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --error: #ef4444;
            --warning: #f59e0b;
            --radius: 20px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; 
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- Layout --- */
        .sidebar {
            width: 280px; background: var(--card); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 24px; z-index: 100;
        }
        .main-content { flex: 1; overflow-y: auto; padding: 24px; position: relative; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { 
                position: fixed; bottom: 0; width: 100%; background: var(--card);
                display: flex; justify-content: space-around; padding: 12px;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
            }
            .main-content { padding: 16px 16px 100px 16px; }
        }

        /* --- UI Components --- */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card); padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); }
        .stat-card span { font-size: 0.8rem; color: var(--muted); font-weight: 600; display: block; margin-bottom: 4px; }
        .stat-card strong { font-size: 1.2rem; color: var(--primary); }

        .card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        
        /* ×œ×•×— ×©× ×” */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; position: relative; font-size: 0.9rem; }
        .day.selected { background: var(--primary); color: white; }
        .day.today { border: 2px solid var(--primary); font-weight: 800; }
        .dot { width: 4px; height: 4px; border-radius: 50%; position: absolute; bottom: 4px; }

        /* × ×™×•×•×˜ ×“×¤×™× */
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }

        /* ×˜×¤×¡×™× */
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--muted); margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; outline: none; }
        .btn { padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }

        /* FAB */
        .fab { position: fixed; bottom: 85px; left: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; border: none; z-index: 999; }

        .event-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 12px; margin-bottom: 8px; border-right: 4px solid var(--primary); }
        .ev-school { border-right-color: var(--secondary); background: #f0fdf4; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 3000; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color: var(--primary); margin-bottom: 30px;">SmartStudent</h2>
        <button class="btn" style="background:var(--primary-light); color:var(--primary); margin-bottom:10px" onclick="switchPage('personal')">ğŸ  ×”×™×•××Ÿ ×©×œ×™</button>
        <button class="btn" style="background:transparent; color:var(--text)" onclick="switchPage('school')">ğŸ« ××™×¨×•×¢×™ ×‘×™×ª ×¡×¤×¨</button>
    </aside>

    <main class="main-content">
        <div class="dashboard">
            <div class="stat-card"><span>×”×™×•×</span><strong id="stat-today">0</strong></div>
            <div class="stat-card"><span>×”××‘×—×Ÿ ×”×‘×</span><strong id="stat-exam">--</strong></div>
            <div class="stat-card"><span>×¢×•××¡ ×©×‘×•×¢×™</span><strong id="stat-week">0</strong></div>
            <div class="stat-card"><span>×¡×˜×˜×•×¡ ×¢× ×Ÿ</span><strong id="stat-cloud" style="color:var(--secondary)">××—×•×‘×¨</strong></div>
        </div>

        <div id="page-personal" class="page active">
            <div style="display: grid; grid-template-columns: 1fr 320px; gap: 20px;">
                <div class="card">
                    <div class="cal-header">
                        <button onclick="changeMonth(-1)" style="border:none;background:none;cursor:pointer">â—€</button>
                        <h3 id="monthLabel"></h3>
                        <button onclick="changeMonth(1)" style="border:none;background:none;cursor:pointer">â–¶</button>
                    </div>
                    <div class="cal-grid" id="calendarGrid"></div>
                </div>
                <div class="card">
                    <h3 id="dateLabel">×”×™×•×</h3>
                    <div id="dailyList"></div>
                    <button class="btn" style="margin-top:10px; border:1px solid var(--primary); color:var(--primary); background:none" onclick="autoPlan()">×¡×“×¨ ×œ×™ ××ª ×”×™×•×</button>
                </div>
            </div>
        </div>

        <div id="page-school" class="page">
            <div class="card">
                <h3>×”×•×¡×¤×ª ××™×¨×•×¢ ×©×›×‘×ª×™ (×¡× ×›×¨×•×Ÿ ×œ×¢× ×Ÿ)</h3>
                <div class="input-group"><input type="text" id="s-title" placeholder="× ×•×©× ×”××™×¨×•×¢"></div>
                <div style="display:flex; gap:10px">
                    <select id="s-class" style="flex:1"><option>×›×œ ×”×©×›×‘×”</option><option>×™'1</option><option>×™'2</option><option>×™'3</option><option>×™'4</option><option>×™'5</option></select>
                    <select id="s-type" style="flex:1"><option>××‘×—×Ÿ</option><option>×‘×•×—×Ÿ</option><option>×˜×™×•×œ</option></select>
                </div>
                <button class="btn btn-primary" style="margin-top:10px" onclick="addSchoolEvent()">×©××•×¨ ×•×¡× ×›×¨×Ÿ ×œ×›×•×œ×</button>
            </div>
            <div id="schoolFullList"></div>
        </div>
    </main>

    <button class="fab" onclick="openQuickAdd()">ï¼‹</button>

    <nav class="bottom-nav">
        <button onclick="switchPage('personal')" style="background:none;border:none">ğŸ </button>
        <button onclick="openQuickAdd()" style="background:none;border:none;font-size:1.5rem">ï¼‹</button>
        <button onclick="switchPage('school')" style="background:none;border:none">ğŸ«</button>
    </nav>

    <div id="toast"></div>

    <script>
        // --- ×”×—×œ×§ ×©×œ ×”-GOOGLE SHEETS ---
        const SCRIPT_URL = "×›××Ÿ_××“×‘×™×§×™×_××ª_×”×›×ª×•×‘×ª_××”×’×•×’×œ_×©×™×˜×¡";

        let schoolEvents = []; 
        let personalEvents = JSON.parse(localStorage.getItem('student_v7_personal')) || [];
        let viewDate = new Date();
        let selectedDate = new Date();

        function normalizeDate(d) { const date = new Date(d); return new Date(date.getFullYear(), date.getMonth(), date.getDate()); }
        selectedDate = normalizeDate(selectedDate);

        // ×˜×¢×™× ×ª × ×ª×•× ×™× ××”×¢× ×Ÿ
        async function loadCloudData() {
            if (SCRIPT_URL.includes("×›××Ÿ_××“×‘×™×§×™×")) {
                document.getElementById('stat-cloud').innerText = "×œ× ××—×•×‘×¨";
                return;
            }
            try {
                const response = await fetch(SCRIPT_URL);
                schoolEvents = await response.json();
                refreshUI();
            } catch(e) { console.error(e); }
        }

        async function addSchoolEvent() {
            const title = document.getElementById('s-title').value;
            if(!title) return;
            showToast("×©×•××¨ ×‘×¢× ×Ÿ...");
            await fetch(SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                body: JSON.stringify({
                    action: "add", title, date: selectedDate.toISOString(),
                    type: document.getElementById('s-type').value, classId: document.getElementById('s-class').value
                })
            });
            document.getElementById('s-title').value = '';
            setTimeout(loadCloudData, 1500);
        }

        // --- × ×™×”×•×œ ×–××Ÿ ×•×ª×¦×•×’×” ---
        function refreshUI() {
            renderCalendar();
            renderDaily();
            renderDashboard();
            renderSchoolList();
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            refreshUI();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('monthLabel').innerText = viewDate.toLocaleDateString('he-IL', { month:'long', year:'numeric'});
            
            const first = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const days = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();

            for (let i = 0; i < first; i++) grid.innerHTML += `<div></div>`;
            for (let d = 1; d <= days; d++) {
                const date = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
                const time = normalizeDate(date).getTime();
                const hasS = schoolEvents.some(e => normalizeDate(e.date).getTime() === time);
                const hasP = personalEvents.some(e => normalizeDate(e.date).getTime() === time);

                grid.innerHTML += `
                    <div class="day ${time === selectedDate.getTime() ? 'selected' : ''}" onclick="selectDate(${d})">
                        ${d}
                        ${hasS ? '<div class="dot" style="background:var(--secondary)"></div>' : ''}
                        ${hasP ? '<div class="dot" style="background:var(--primary); left:45%"></div>' : ''}
                    </div>`;
            }
        }

        function renderDaily() {
            const list = document.getElementById('dailyList');
            document.getElementById('dateLabel').innerText = selectedDate.toLocaleDateString('he-IL');
            list.innerHTML = '';
            const time = selectedDate.getTime();

            // ××™×¨×•×¢×™ ×¢× ×Ÿ
            schoolEvents.filter(e => normalizeDate(e.date).getTime() === time).forEach(e => {
                list.innerHTML += `<div class="event-card ev-school"><div><strong>${e.title}</strong><span>${e.classId}</span></div></div>`;
            });
            // ××™×©×™
            personalEvents.filter(e => normalizeDate(e.date).getTime() === time).forEach(e => {
                list.innerHTML += `<div class="event-card"><div><strong>${e.title}</strong><span>××™×©×™</span></div></div>`;
            });
        }

        function renderDashboard() {
            const todayCount = schoolEvents.filter(e => normalizeDate(e.date).getTime() === normalizeDate(new Date()).getTime()).length;
            document.getElementById('stat-today').innerText = todayCount;
            const exams = schoolEvents.filter(e => e.type === '××‘×—×Ÿ' && normalizeDate(e.date) >= normalizeDate(new Date()));
            document.getElementById('stat-exam').innerText = exams.length > 0 ? exams[0].title : '--';
        }

        function renderSchoolList() {
            const list = document.getElementById('schoolFullList');
            list.innerHTML = '<h3>×›×œ ×”××‘×—× ×™× ×•×”××™×¨×•×¢×™×:</h3>';
            schoolEvents.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(e => {
                list.innerHTML += `<div class="event-card ev-school"><div><strong>${e.title}</strong><span>${new Date(e.date).toLocaleDateString('he-IL')}</span></div></div>`;
            });
        }

        function selectDate(d) { selectedDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d); refreshUI(); }
        function changeMonth(delta) { viewDate.setMonth(viewDate.getMonth() + delta); renderCalendar(); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none',3000); }
        function openQuickAdd() { const t = prompt("× ×•×©× ×œ××©×™××” ××™×©×™×ª:"); if(t) { personalEvents.push({title:t, date:selectedDate.toISOString()}); localStorage.setItem('student_v7_personal', JSON.stringify(personalEvents)); refreshUI(); } }

        loadCloudData();
    </script>
</body>
</html>