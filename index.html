<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××ª×›× ×Ÿ ××™×¨×•×¢×™× ×©×›×‘×ª×™</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #3f51b5;
            --bg-app: #f5f6fa;
            --bg-card: #ffffff;
            --text-dark: #333333;
            --text-muted: #757575;
            --accent-red: #e74c3c;
            --border-light: #e0e0e0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-dark);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        header {
            width: 100%; background-color: var(--bg-card);
            padding: 15px 0; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
        }

        .app-container { width: 92%; max-width: 600px; padding: 20px 0 100px 0; }

        .card {
            background: var(--bg-card); padding: 20px;
            border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04);
            margin-bottom: 25px;
        }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }

        .material-input {
            width: 100%; padding: 12px 5px; border: none;
            border-bottom: 2px solid var(--border-light);
            background: transparent; font-size: 1rem; outline: none;
        }

        .btn-save {
            width: 100%; padding: 16px; background: var(--primary);
            color: white; border: none; border-radius: 15px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(63, 81, 181, 0.3);
        }

        /* ×œ×•×— ×©× ×” */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .weekday-label { font-weight: 700; color: var(--text-muted); font-size: 0.75rem; padding-bottom: 10px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; cursor: pointer; border-radius: 50%; position: relative; }
        .calendar-day.today { border: 1.5px solid var(--primary); color: var(--primary); }
        .marker { height: 4px; width: 4px; border-radius: 50%; background: var(--accent-red); margin: auto; position: absolute; bottom: 4px;}

        /* ×¡×¨×’×œ ×¡×™× ×•×Ÿ ×–××Ÿ */
        .time-filters {
            display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;
        }
        .time-chip {
            padding: 8px 16px; background: #e2e8f0; border-radius: 20px;
            font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap;
            transition: all 0.2s; color: var(--text-muted); border: none;
        }
        .time-chip.active { background: var(--primary); color: white; box-shadow: 0 4px 8px rgba(63, 81, 181, 0.2); }

        /* ×¨×©×™××ª ××™×¨×•×¢×™× */
        .section-title { font-size: 1.2rem; font-weight: 700; margin: 10px 5px 15px 5px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
        .event-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: white; border-radius: 18px; margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04); border-right: 5px solid var(--primary);
        }
        .event-date-box { text-align: center; background: var(--bg-app); padding: 8px; border-radius: 12px; min-width: 50px; }
        .event-date-box .day { font-size: 1.1rem; font-weight: 700; display: block; color: var(--primary); }
        .event-date-box .month { font-size: 0.7rem; font-weight: 600; }
        .delete-btn { color: var(--accent-red); background: none; border: none; cursor: pointer; padding: 10px; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 1000; }
    </style>
</head>
<body>

<header>
    <h1>×œ×•×— ××™×¨×•×¢×™× ×©×›×‘×ª×™</h1>
</header>

<div class="app-container">
    <div class="card">
        <div class="input-group">
            <label>× ×•×©× ×”××™×¨×•×¢</label>
            <input type="text" id="title" class="material-input" placeholder="×”×§×œ×“ × ×•×©×...">
        </div>
        <div style="display:flex; gap:15px; margin-bottom:20px;">
            <div class="input-group" style="flex:1;">
                <label>×›×™×ª×”</label>
                <select id="classId" class="material-input">
                    <option>×›×œ ×”×©×›×‘×” â­</option><option>×™'1</option><option>×™'2</option><option>×™'3</option><option>×™'4</option><option>×™'5</option>
                </select>
            </div>
            <div class="input-group" style="flex:1;">
                <label>×¡×•×’</label>
                <select id="type" class="material-input">
                    <option>××‘×—×Ÿ</option><option>×‘×•×—×Ÿ</option><option>×¤×¢×™×œ×•×ª</option>
                </select>
            </div>
        </div>
        <button class="btn-save" onclick="addEvent()">×©××•×¨ ××™×¨×•×¢</button>
    </div>

    <div class="card">
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="section-title">
        <span class="material-icons-round">schedule</span>
        ××™×¨×•×¢×™× ×§×¨×•×‘×™×
    </div>
    
    <div class="time-filters">
        <button class="time-chip" id="filter-week" onclick="setTimeFilter(7, this)">×”×©×‘×•×¢</button>
        <button class="time-chip" id="filter-month" onclick="setTimeFilter(30, this)">×”×—×•×“×©</button>
        <button class="time-chip" id="filter-year" onclick="setTimeFilter(365, this)">×”×©× ×”</button>
        <button class="time-chip active" id="filter-all" onclick="setTimeFilter(0, this)">×”×›×œ</button>
    </div>

    <div id="fullEventList"></div>
</div>

<div id="toast"></div>

<script>
    // --- ×—×•×‘×”: ×”×œ×™× ×§ ×©×œ×š ××’×•×’×œ ×©×™×˜×¡ ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjUOZw7k1RUW9HArAZPEpdX7L1HP5jpMGasjeFC0jwNSylvDLUEyYQUqIq46YhEpTu/exec";

    let events = [];
    let currentTimeFilter = 0; // 0 = ×”×›×œ

    function normalizeDate(d) { 
        const date = new Date(d); 
        return new Date(date.getFullYear(), date.getMonth(), date.getDate()); 
    }

    async function loadEvents() {
        if (SCRIPT_URL.includes("×›××Ÿ_××“×‘×™×§×™×")) return;
        try {
            const response = await fetch(SCRIPT_URL);
            events = await response.json();
            renderCalendar();
            displayFullEventList();
        } catch (e) { console.error(e); }
    }

    // ×”×’×“×¨×ª ×¡×™× ×•×Ÿ ×–××Ÿ
    function setTimeFilter(days, el) {
        currentTimeFilter = days;
        // ×¢×“×›×•×Ÿ ×¢×™×¦×•×‘ ×”×›×¤×ª×•×¨×™×
        document.querySelectorAll('.time-chip').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        displayFullEventList();
    }

    function displayFullEventList() {
        const list = document.getElementById('fullEventList');
        list.innerHTML = '';

        const today = normalizeDate(new Date());
        
        // ×¡×™× ×•×Ÿ ×œ×¤×™ ×˜×•×•×— ×–××Ÿ
        let filtered = events.filter(ev => {
            const evDate = new Date(ev.date);
            if (currentTimeFilter === 0) return true; // ×”×›×œ
            
            const diffTime = evDate - today;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            return diffDays >= 0 && diffDays <= currentTimeFilter;
        });

        if (filtered.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">××™×Ÿ ××™×¨×•×¢×™× ×‘×˜×•×•×— ×”×–××Ÿ ×©× ×‘×—×¨</div>';
            return;
        }

        filtered.sort((a, b) => new Date(a.date) - new Date(b.date));

        filtered.forEach(ev => {
            const dateObj = new Date(ev.date);
            list.innerHTML += `
                <div class="event-card">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="event-date-box">
                            <span class="day">${dateObj.getDate()}</span>
                            <span class="month">${dateObj.toLocaleDateString('he-IL', { month: 'short' })}</span>
                        </div>
                        <div class="event-info">
                            <strong>${ev.title}</strong>
                            <span>ğŸ“ ${ev.classId} | ğŸ·ï¸ ${ev.type}</span>
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteEvent('${ev.id}')">
                        <span class="material-icons-round">delete_outline</span>
                    </button>
                </div>`;
        });
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        ['×', '×‘', '×’', '×“', '×”', '×•', '×©'].forEach(d => grid.innerHTML += `<div class="weekday-label">${d}</div>`);
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day"></div>`;
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(now.getFullYear(), now.getMonth(), day);
            const hasEvent = events.some(e => normalizeDate(e.date).getTime() === normalizeDate(date).getTime());
            grid.innerHTML += `<div class="calendar-day ${normalizeDate(date).getTime() === normalizeDate(now).getTime() ? 'today' : ''}">${day}${hasEvent ? '<div class="marker"></div>' : ''}</div>`;
        }
    }

    async function addEvent() {
        const title = document.getElementById('title').value;
        if (!title) return showToast("× × ×œ×”×–×™×Ÿ × ×•×©×");
        showToast("×©×•××¨...");
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ 
            action: "add", title, date: new Date().toISOString(), 
            classId: document.getElementById('classId').value, type: document.getElementById('type').value 
        })});
        setTimeout(() => { document.getElementById('title').value = ''; loadEvents(); }, 1500);
    }

    async function deleteEvent(id) {
        if(!confirm("×œ××—×•×§?")) return;
        await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", id }) });
        setTimeout(loadEvents, 1000);
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    loadEvents();
    renderCalendar();
</script>
</body>
</html>