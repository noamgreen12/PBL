<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStudent AI Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #eef2ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --exam: #ef4444;
            --study: #f59e0b;
            --homework: #10b981;
            --activity: #0ea5e9;
            --school: #6366f1;
            --radius: 18px;
            --sidebar-w: 260px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar & Layout --- */
        .sidebar { width: var(--sidebar-w); background: var(--card); border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 1000; overflow-y: auto; }
        .main-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid var(--border); z-index: 2000; }
            .main-content { padding-bottom: 80px; }
        }

        /* --- AI Insights Header --- */
        .ai-header { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 15px 20px; border-radius: 0 0 25px 25px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .ai-header small { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }
        .ai-header p { margin: 8px 0 0; font-size: 0.95rem; font-weight: 500; }

        /* --- Navigation --- */
        .top-nav { padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px; }
        .segmented-control { display: flex; background: var(--bg); padding: 4px; border-radius: 12px; }
        .seg-btn { border: none; background: none; padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer; color: var(--muted); }
        .seg-btn.active { background: var(--card); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- Views Rendering --- */
        .view-container { padding: 20px; flex: 1; }

        /* Day View */
        .timeline { position: relative; padding-right: 55px; }
        .time-row { height: 65px; border-top: 1px solid var(--border); position: relative; }
        .time-label { position: absolute; right: -55px; top: -10px; font-size: 0.75rem; color: var(--muted); }
        .ev-block { position: absolute; left: 0; right: 0; background: var(--primary-light); border-right: 4px solid var(--primary); padding: 8px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; z-index: 10; overflow: hidden; }

        /* Month View */
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .month-day { aspect-ratio: 1; background: var(--card); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--border); cursor: pointer; position: relative; }
        .month-day.selected { border: 2px solid var(--primary); background: var(--primary-light); }
        .month-day.today { color: var(--primary); font-weight: 800; }
        .dots { display: flex; gap: 2px; position: absolute; bottom: 5px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* Year View */
        .year-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .mini-month { background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; font-size: 0.65rem; }
        .mini-month:hover { border-color: var(--primary); }

        /* --- Modals & Forms --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center; }
        .modal { background: white; padding: 25px; border-radius: 24px; width: 90%; max-width: 450px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--muted); margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; }
        .conflict-alert { background: #fff1f2; color: #e11d48; padding: 10px; border-radius: 8px; font-size: 0.75rem; margin-bottom: 15px; display: none; border: 1px solid #fda4af; }

        .btn { padding: 14px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .fab { position: fixed; bottom: 85px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); cursor: pointer; z-index: 1500; }

        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; display: none; z-index: 4000; font-size: 0.85rem; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color:var(--primary); margin-bottom:30px;">SmartStudent AI</h2>
        
        <div style="margin-bottom:25px;">
            <label style="font-size:0.7rem; color:var(--muted); text-transform:uppercase;">×œ×•×—×•×ª</label>
            <button class="btn" id="board-p" style="background:var(--primary-light); color:var(--primary); text-align:right; width:100%; margin:8px 0;" onclick="switchBoard('personal')">ğŸ“… ×”×™×•××Ÿ ×©×œ×™</button>
            <button class="btn" id="board-s" style="background:transparent; color:var(--muted); text-align:right; width:100%;" onclick="switchBoard('school')">ğŸ« ×œ×•×— ×‘×™×ª ×¡×¤×¨</button>
        </div>

        <div style="margin-bottom:25px;">
            <label style="font-size:0.7rem; color:var(--muted); text-transform:uppercase;">×¡×™× ×•×Ÿ</label>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;"><input type="checkbox" checked onchange="toggleFilter('××‘×—×Ÿ')" id="f-××‘×—×Ÿ"> ××‘×—× ×™× <span style="background:var(--exam); width:8px; height:8px; border-radius:50%"></span></label>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;"><input type="checkbox" checked onchange="toggleFilter('××˜×œ×”')" id="f-××˜×œ×”"> ×©×™×¢×•×¨×™× <span style="background:var(--homework); width:8px; height:8px; border-radius:50%"></span></label>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;"><input type="checkbox" checked onchange="toggleFilter('×œ××™×“×”')" id="f-×œ××™×“×”"> ×œ××™×“×” <span style="background:var(--study); width:8px; height:8px; border-radius:50%"></span></label>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem;"><input type="checkbox" onchange="toggleFilter('overlay')" id="f-overlay"> ×”×¦×’ ×©×›×‘×ª ×‘×™"×¡</label>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="ai-header">
            <small>AI INSIGHTS</small>
            <p id="ai-insight">×× ×ª×— ××ª ×”×œ×•"×– ×©×œ×š ×œ×¢×“×›×•× ×™× ×—×›××™×...</p>
        </div>

        <div class="top-nav">
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="move(-1)" style="border:none;background:none;cursor:pointer;">â–¶</button>
                <strong id="viewLabel" style="min-width:120px; text-align:center;">×™× ×•××¨ 2026</strong>
                <button onclick="move(1)" style="border:none;background:none;cursor:pointer;">â—€</button>
            </div>
            <div class="segmented-control">
                <button class="seg-btn" id="seg-day" onclick="changeView('day')">×”×™×•×</button>
                <button class="seg-btn" id="seg-week" onclick="changeView('week')">×©×‘×•×¢</button>
                <button class="seg-btn active" id="seg-month" onclick="changeView('month')">×—×•×“×©</button>
                <button class="seg-btn" id="seg-year" onclick="changeView('year')">×©× ×”</button>
            </div>
        </div>

        <div class="view-container" id="viewContainer"></div>
    </main>

    <button class="fab" onclick="openModal()">+</button>

    <div class="overlay" id="eventModal">
        <div class="modal">
            <h3 id="modalTitle">××™×¨×•×¢ ×—×“×©</h3>
            <div class="conflict-alert" id="conflict-msg">âš ï¸ ×©×™× ×œ×‘: ×›×‘×¨ ×§×™×™× ××™×¨×•×¢ ×‘×©×¢×” ×–×•!</div>
            <div class="form-group">
                <label>×›×•×ª×¨×ª</label>
                <input type="text" id="ev-title" oninput="validateTime()">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>×¡×•×’</label>
                    <select id="ev-type" onchange="toggleAutoStudy()">
                        <option value="××˜×œ×”">×©×™×¢×•×¨×™× / ×¢×‘×•×“×”</option>
                        <option value="××‘×—×Ÿ">××‘×—×Ÿ</option>
                        <option value="×¤×¢×™×œ×•×ª">×¤×¢×™×œ×•×ª / ×—×•×’</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>×ª××¨×™×š</label>
                    <input type="date" id="ev-date" onchange="validateTime()">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>×©×¢×”</label>
                    <input type="time" id="ev-time" value="16:00" onchange="validateTime()">
                </div>
                <div class="form-group" style="flex:1">
                    <label>××©×š (×“×§×•×ª)</label>
                    <input type="number" id="ev-dur" value="60">
                </div>
            </div>
            <div id="ai-planner" style="display:none; background:var(--primary-light); padding:10px; border-radius:10px; margin-bottom:15px;">
                <label style="display:flex; align-items:center; gap:8px; color:var(--primary); margin:0; cursor:pointer;">
                    <input type="checkbox" id="ev-auto" checked> ×ª×›× ×Ÿ ×œ×™ ×–××Ÿ ×œ××™×“×” ××•×˜×•××˜×™ (AI)
                </label>
            </div>
            <button class="btn btn-primary" onclick="save()">×©××•×¨ ××™×¨×•×¢</button>
            <button class="btn" style="background:none; color:var(--muted); width:100%; margin-top:10px;" onclick="closeModal()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjUOZw7k1RUW9HArAZPEpdX7L1HP5jpMGasjeFC0jwNSylvDLUEyYQUqIq46YhEpTu/exec"; // ×œ×™× ×§ ×œ×©×™×˜×¡ ×‘××™×“×” ×•×™×©
        let personalEvents = JSON.parse(localStorage.getItem('student_ai_v11')) || [];
        let schoolEvents = [];
        let board = 'personal';
        let view = 'month';
        let date = new Date();
        let filters = { ××‘×—×Ÿ: true, ××˜×œ×”: true, ×œ××™×“×”: true, overlay: false };

        function init() {
            render();
            // Shortcuts
            window.addEventListener('keydown', e => {
                if(e.key.toLowerCase() === 'n') openModal();
                if(e.key === 'ArrowRight') move(-1);
                if(e.key === 'ArrowLeft') move(1);
            });
        }

        function render() {
            const container = document.getElementById('viewContainer');
            container.innerHTML = '';
            updateHeader();
            runAI();

            if(view === 'month') renderMonth(container);
            else if(view === 'day') renderDay(container);
            else if(view === 'year') renderYear(container);
            else renderWeek(container);
        }

        function updateHeader() {
            const label = document.getElementById('viewLabel');
            const opts = { month: 'long', year: 'numeric' };
            if(view === 'day') label.innerText = date.toLocaleDateString('he-IL', {day:'numeric', ...opts});
            else if(view === 'year') label.innerText = date.getFullYear();
            else label.innerText = date.toLocaleDateString('he-IL', opts);
        }

        function getEvents() {
            let list = board === 'personal' ? personalEvents : schoolEvents;
            let filtered = list.filter(e => filters[e.type] || e.type === '×¤×¢×™×œ×•×ª');
            if(board === 'personal' && filters.overlay) filtered = [...filtered, ...schoolEvents];
            return filtered;
        }

        // --- View Renderers ---
        function renderMonth(container) {
            const grid = document.createElement('div');
            grid.className = 'month-grid';
            const year = date.getFullYear(), month = date.getMonth();
            const first = new Date(year, month, 1).getDay();
            const days = new Date(year, month + 1, 0).getDate();

            ['×','×‘','×’','×“','×”','×•','×©'].forEach(d => grid.innerHTML += `<div style="text-align:center;font-weight:800;font-size:0.7rem;color:var(--muted)">${d}</div>`);
            for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';

            const evs = getEvents();
            for(let d=1; d<=days; d++) {
                const dDate = new Date(year, month, d).toISOString().split('T')[0];
                const dayEvs = evs.filter(e => e.date === dDate);
                const isSelected = dDate === date.toISOString().split('T')[0];
                
                const el = document.createElement('div');
                el.className = `month-day ${isSelected ? 'selected' : ''}`;
                el.innerHTML = d;
                const dots = document.createElement('div');
                dots.className = 'dots';
                dayEvs.slice(0,3).forEach(e => {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.style.background = `var(--${e.type==='××‘×—×Ÿ'?'exam':(e.type==='×œ××™×“×”'?'study':'homework')})`;
                    dots.appendChild(dot);
                });
                el.appendChild(dots);
                el.onclick = () => { date = new Date(year, month, d); changeView('day'); };
                grid.appendChild(el);
            }
            container.appendChild(grid);
        }

        function renderDay(container) {
            const tl = document.createElement('div');
            tl.className = 'timeline';
            const dateStr = date.toISOString().split('T')[0];
            const evs = getEvents().filter(e => e.date === dateStr);

            for(let h=8; h<=22; h++) {
                const row = document.createElement('div');
                row.className = 'time-row';
                row.innerHTML = `<div class="time-label">${h}:00</div>`;
                const hEvs = evs.filter(e => parseInt(e.time.split(':')[0]) === h);
                hEvs.forEach(e => {
                    row.innerHTML += `<div class="ev-block" style="border-right-color:var(--${e.type==='××‘×—×Ÿ'?'exam':(e.type==='×œ××™×“×”'?'study':'homework')})">
                        <strong>${e.title}</strong><br><small>${e.time}</small>
                    </div>`;
                });
                tl.appendChild(row);
            }
            container.appendChild(tl);
        }

        function renderYear(container) {
            const grid = document.createElement('div');
            grid.className = 'year-grid';
            for(let m=0; m<12; m++) {
                const d = new Date(date.getFullYear(), m, 1);
                grid.innerHTML += `<div class="mini-month" onclick="goToMonth(${m})">
                    <div style="font-weight:800; text-align:center; color:var(--primary); margin-bottom:5px;">${d.toLocaleDateString('he-IL', {month:'long'})}</div>
                    <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:1px; text-align:center;">
                        ${Array.from({length:31}, (_,i) => `<div>${i+1}</div>`).join('')}
                    </div>
                </div>`;
            }
            container.appendChild(grid);
        }

        function renderWeek(container) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:var(--muted)">××‘×˜ ×©×‘×•×¢×™ ×‘×ª×”×œ×™×š... ××•××œ×¥ ×œ×”×©×ª××© ×‘××‘×˜ ×™×•× ××• ×—×•×“×©.</div>`;
        }

        // --- AI Logic ---
        function runAI() {
            const bar = document.getElementById('ai-insight');
            const now = new Date();
            const week = new Date(); week.setDate(now.getDate() + 7);
            const evs = [...personalEvents, ...schoolEvents].filter(e => new Date(e.date) >= now && new Date(e.date) <= week);
            const exams = evs.filter(e => e.type === '××‘×—×Ÿ');

            if(exams.length >= 2) bar.innerHTML = `âš ï¸ ×¢×•××¡ ×’×‘×•×”: ×™×© ×œ×š ${exams.length} ××‘×—× ×™× ×”×©×‘×•×¢. ×›×“××™ ×œ×”×ª×—×™×œ ×œ×œ××•×“ ×›×‘×¨ ×‘×™×•× ${new Date(exams[0].date).toLocaleDateString('he-IL', {weekday:'long'})}.`;
            else if(exams.length === 1) bar.innerHTML = `ğŸ’¡ ×”××‘×—×Ÿ ×”×§×¨×•×‘: ${exams[0].title}. ××¦××ª×™ ×œ×š ×—×œ×•×Ÿ ×¤× ×•×™ ×œ×œ××™×“×” ×‘×™×•× ×©× ×¨××” ×”×›×™ ×¤×—×•×ª ×¢××•×¡.`;
            else bar.innerHTML = `ğŸŒŸ ×”×©×‘×•×¢ × ×¨××” ×××•×–×Ÿ. ×–××Ÿ ××¦×•×™×Ÿ ×œ×¡×’×•×¨ ×¤×¢×¨×™× ×‘××˜×œ×•×ª ×§×˜× ×•×ª.`;
        }

        function validateTime() {
            const d = document.getElementById('ev-date').value;
            const t = document.getElementById('ev-time').value;
            const conflict = [...personalEvents, ...schoolEvents].some(e => e.date === d && e.time === t);
            document.getElementById('conflict-msg').style.display = conflict ? 'block' : 'none';
        }

        function save() {
            const title = document.getElementById('ev-title').value;
            const d = document.getElementById('ev-date').value;
            const t = document.getElementById('ev-time').value;
            const type = document.getElementById('ev-type').value;
            if(!title || !d) return;

            const ev = { id: Date.now().toString(), title, date: d, time: t, type, dur: document.getElementById('ev-dur').value };
            
            if(board === 'personal') {
                personalEvents.push(ev);
                if(type === '××‘×—×Ÿ' && document.getElementById('ev-auto').checked) planAI(title, d);
                localStorage.setItem('student_ai_v11', JSON.stringify(personalEvents));
            }
            closeModal();
            render();
            showToast("× ×©××¨ ×‘×”×¦×œ×—×”!");
        }

        function planAI(title, examDateStr) {
            const examDate = new Date(examDateStr);
            for(let i=1; i<=3; i++) {
                let sDate = new Date(examDate); sDate.setDate(examDate.getDate() - i);
                if(sDate < new Date()) continue;
                
                let sTime = "17:00";
                // ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×—×›××”
                if([...personalEvents, ...schoolEvents].some(e => e.date === sDate.toISOString().split('T')[0] && e.time === sTime)) sTime = "19:00";

                personalEvents.push({ id: Date.now()+i, title: "×œ××™×“×”: " + title, date: sDate.toISOString().split('T')[0], time: sTime, type: '×œ××™×“×”', dur: 90 });
            }
        }

        // --- Helpers ---
        function switchBoard(b) { 
            board = b; 
            document.getElementById('board-p').style.background = b==='personal'?'var(--primary-light)':'none';
            document.getElementById('board-s').style.background = b==='school'?'var(--primary-light)':'none';
            render(); 
        }
        function changeView(v) { 
            view = v; 
            document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('seg-'+v).classList.add('active');
            render(); 
        }
        function move(dir) {
            if(view === 'day') date.setDate(date.getDate() + dir);
            else if(view === 'year') date.setFullYear(date.getFullYear() + dir);
            else date.setMonth(date.getMonth() + dir);
            render();
        }
        function openModal() { document.getElementById('eventModal').style.display = 'flex'; document.getElementById('ev-date').value = date.toISOString().split('T')[0]; }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }
        function toggleAutoStudy() { document.getElementById('ai-planner').style.display = document.getElementById('ev-type').value === '××‘×—×Ÿ' ? 'block' : 'none'; }
        function toggleFilter(f) { filters[f] = document.getElementById('f-'+f).checked; render(); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none',3000); }
        function goToMonth(m) { date.setMonth(m); changeView('month'); }

        init();
    </script>
</body>
</html>